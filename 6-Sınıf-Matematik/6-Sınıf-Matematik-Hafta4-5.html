<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. SÄ±nÄ±f Ä°statistik Dedektifi</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
        }
        .phase-container {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .phase-container.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bar {
            transition: height 1s ease-out, background-color 0.3s;
        }
        .bar:hover {
            filter: brightness(1.1);
        }
        /* Custom Tally Marks Font Simulation */
        .tally-text {
            letter-spacing: 2px;
            color: #555;
            font-family: monospace;
            font-weight: bold;
        }
        .character {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .character:active {
            transform: scale(0.9);
        }
        .character.disabled {
            opacity: 0.5;
            cursor: default;
            pointer-events: none;
        }
        .speech-bubble {
            position: relative;
            background: #ffffff;
            border-radius: .4em;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #ffffff;
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }
        /* Scrollbar styling for table/grid */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center text-slate-700 overflow-hidden">

    <!-- Header -->
    <header class="absolute top-0 w-full p-3 md:p-4 bg-white text-slate-800 shadow-md z-20 flex justify-between items-center border-b border-slate-200">
        <!-- Left: Logo & Title -->
        <div class="flex items-center gap-3">
            <!-- Logo -->
            <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" alt="Logo" class="h-8 md:h-10">
            <h1 class="text-lg md:text-2xl font-bold truncate text-indigo-900">Ä°statistik Dedektifi</h1>
        </div>
        
        <!-- Right: Progress & Home -->
        <div class="flex items-center gap-3">
            <div class="text-xs md:text-sm bg-indigo-50 text-indigo-700 border border-indigo-100 px-3 py-1 rounded-full whitespace-nowrap font-bold" id="progress-indicator">
                AÅŸama: Seviye SeÃ§imi
            </div>
            
            <button onclick="goHomeSafe()" class="bg-indigo-600 hover:bg-indigo-700 p-2 rounded-lg transition-colors shadow-sm flex items-center justify-center" title="Anasayfa">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="w-full max-w-6xl h-full pt-20 pb-4 px-4 flex flex-col">

        <!-- PHASE 0: LEVEL SELECTION -->
        <div id="phase-0" class="phase-container active flex-col items-center justify-center h-full gap-6">
            <div class="text-center max-w-2xl">
                <h2 class="text-3xl font-bold text-indigo-900 mb-2">Zorluk Seviyeni SeÃ§</h2>
                <p class="text-lg text-slate-600">Kendine uygun bir dedektiflik gÃ¶revi seÃ§erek baÅŸla.</p>
            </div>

            <div class="flex flex-col md:flex-row gap-6 w-full justify-center items-stretch px-4">
                <!-- Level 1: Easy -->
                <button onclick="selectLevel('easy')" class="group relative bg-white border-4 border-green-400 rounded-2xl p-6 w-full md:w-1/3 hover:shadow-2xl hover:-translate-y-2 transition-all text-center flex flex-col items-center justify-between">
                    <div>
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">â­</div>
                        <h3 class="text-2xl font-bold text-green-600 mb-2">Acemi Dedektif</h3>
                        <p class="text-sm text-slate-500 mb-4">Az sayÄ±da veri topla. Grafikte "En Ã§ok" ve "En az" olanÄ± bul.</p>
                    </div>
                    <div class="w-full bg-green-50 rounded-lg p-2 text-xs text-green-800 font-bold">
                        Hedef: 10-15 Veri
                    </div>
                </button>

                <!-- Level 2: Medium -->
                <button onclick="selectLevel('medium')" class="group relative bg-white border-4 border-yellow-400 rounded-2xl p-6 w-full md:w-1/3 hover:shadow-2xl hover:-translate-y-2 transition-all text-center flex flex-col items-center justify-between">
                    <div>
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform tracking-widest">â­â­</div>
                        <h3 class="text-2xl font-bold text-yellow-600 mb-2">Uzman Dedektif</h3>
                        <p class="text-sm text-slate-500 mb-4">Daha fazla veri topla. Toplama iÅŸlemleri ve grup sayÄ±larÄ±nÄ± bul.</p>
                    </div>
                    <div class="w-full bg-yellow-50 rounded-lg p-2 text-xs text-yellow-800 font-bold">
                        Hedef: 15-25 Veri
                    </div>
                </button>

                <!-- Level 3: Hard -->
                <button onclick="selectLevel('hard')" class="group relative bg-white border-4 border-red-400 rounded-2xl p-6 w-full md:w-1/3 hover:shadow-2xl hover:-translate-y-2 transition-all text-center flex flex-col items-center justify-between">
                    <div>
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform tracking-widest">â­â­â­</div>
                        <h3 class="text-2xl font-bold text-red-600 mb-2">BaÅŸ Dedektif</h3>
                        <p class="text-sm text-slate-500 mb-4">BÃ¼yÃ¼k veri grubuyla Ã§alÄ±ÅŸ. KarmaÅŸÄ±k iÅŸlemler ve kÄ±yaslamalar yap.</p>
                    </div>
                    <div class="w-full bg-red-50 rounded-lg p-2 text-xs text-red-800 font-bold">
                        Hedef: 30-40 Veri
                    </div>
                </button>
            </div>
        </div>
        
        <!-- PHASE 1: SCENARIO SELECTION -->
        <div id="phase-1" class="phase-container flex-col items-center justify-center h-full gap-4 overflow-y-auto">
            <div class="text-center max-w-2xl mt-4 shrink-0 relative w-full">
                <!-- Inner Back Button (Optional quick nav) -->
                <button onclick="resetSim()" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-sm bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-full text-slate-600 font-bold transition-colors">ğŸ¡  Geri</button>
                <h2 class="text-2xl md:text-3xl font-bold text-indigo-900 mb-2">Bir AraÅŸtÄ±rma Sorusu SeÃ§</h2>
                <p class="text-base md:text-lg text-slate-600">AraÅŸtÄ±rma yapmak istediÄŸin konuyu seÃ§.</p>
            </div>

            <div class="w-full p-2 overflow-y-auto" style="max-height: 80vh;">
                
                <!-- KATEGORÄ°K BÃ–LÃœMÃœ -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-orange-600 mb-3 border-b-2 border-orange-200 pb-1">ğŸ”¸ Kategorik Veri KonularÄ± (Nitel)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                         <!-- 1. Kutu OyunlarÄ± -->
                        <button onclick="selectScenario('boardgames')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ²</div>
                            <h3 class="text-lg font-bold text-slate-700">En Sevilen Kutu Oyunu</h3>
                        </button>
                         <!-- 2. Spor DallarÄ± -->
                        <button onclick="selectScenario('sports')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">âš½</div>
                            <h3 class="text-lg font-bold text-slate-700">En Sevilen Spor</h3>
                        </button>
                         <!-- 3. Video Oyun TÃ¼rÃ¼ -->
                        <button onclick="selectScenario('videogames')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ®</div>
                            <h3 class="text-lg font-bold text-slate-700">Oyun TÃ¼rÃ¼</h3>
                        </button>
                        <!-- 4. Dondurma -->
                        <button onclick="selectScenario('icecream')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ¦</div>
                            <h3 class="text-lg font-bold text-slate-700">Sevilen Dondurma</h3>
                        </button>
                        <!-- 5. Evcil Hayvan -->
                        <button onclick="selectScenario('pets')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ¾</div>
                            <h3 class="text-lg font-bold text-slate-700">Ä°stenen Evcil Hayvan</h3>
                        </button>
                        <!-- 6. Tatil Yeri -->
                        <button onclick="selectScenario('holidays')" class="group relative bg-white border-4 border-orange-200 hover:border-orange-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">â˜€ï¸</div>
                            <h3 class="text-lg font-bold text-slate-700">Tatil Tercihi</h3>
                        </button>
                    </div>
                </div>

                <!-- NÄ°CEL BÃ–LÃœMÃœ -->
                <div>
                    <h3 class="text-xl font-bold text-indigo-600 mb-3 border-b-2 border-indigo-200 pb-1">ğŸ”¹ Nicel Veri KonularÄ± (SayÄ±sal)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- 1. Oyuncak SayÄ±sÄ± -->
                        <button onclick="selectScenario('toys')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ§¸</div>
                            <h3 class="text-lg font-bold text-slate-700">Oyuncak SayÄ±sÄ±</h3>
                        </button>
                        <!-- 2. Ekran SÃ¼resi -->
                        <button onclick="selectScenario('screentime')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ“±</div>
                            <h3 class="text-lg font-bold text-slate-700">GÃ¼nlÃ¼k Ekran SÃ¼resi</h3>
                        </button>
                         <!-- 3. KardeÅŸ SayÄ±sÄ± -->
                        <button onclick="selectScenario('siblings')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ‘¶</div>
                            <h3 class="text-lg font-bold text-slate-700">KardeÅŸ SayÄ±sÄ±</h3>
                        </button>
                        <!-- 4. Kitap SayÄ±sÄ± -->
                        <button onclick="selectScenario('books')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">ğŸ“–</div>
                            <h3 class="text-lg font-bold text-slate-700">Okunan Kitap (AylÄ±k)</h3>
                        </button>
                        <!-- 5. Kalem SayÄ±sÄ± -->
                        <button onclick="selectScenario('pencils')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">âœï¸</div>
                            <h3 class="text-lg font-bold text-slate-700">Kalemlikteki Kalem</h3>
                        </button>
                        <!-- 6. Soru SayÄ±sÄ± -->
                        <button onclick="selectScenario('questions')" class="group relative bg-white border-4 border-indigo-200 hover:border-indigo-400 rounded-2xl p-4 hover:shadow-xl hover:-translate-y-1 transition-all text-center flex flex-col items-center">
                            <div class="text-5xl mb-2 group-hover:scale-110 transition-transform">â“</div>
                            <h3 class="text-lg font-bold text-slate-700">Ã‡Ã¶zÃ¼len Soru (GÃ¼nlÃ¼k)</h3>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- PHASE 2: DATA COLLECTION -->
        <div id="phase-2" class="phase-container flex-col h-full gap-4">
            <div class="text-center shrink-0">
                <h2 class="text-2xl font-bold text-indigo-900">Veri Toplama SahasÄ±</h2>
                <p class="text-slate-600">Ã–ÄŸrencilere tÄ±kla ve cevaplarÄ±nÄ± tabloya iÅŸle. <span id="level-instruction" class="font-bold text-indigo-600"></span></p>
            </div>

            <div class="flex flex-col md:flex-row gap-4 h-full overflow-hidden">
                <!-- Field Area -->
                <div class="flex-1 bg-gradient-to-b from-blue-100 to-green-100 rounded-2xl border-2 border-indigo-100 p-4 relative flex flex-col items-center justify-center overflow-y-auto">
                    <div id="student-container" class="grid grid-cols-3 gap-8 w-full max-w-md place-items-center pb-10">
                        <!-- Students generated by JS -->
                    </div>
                    <div id="collection-status" class="sticky bottom-2 mt-4 bg-white/90 px-4 py-2 rounded-full font-bold text-indigo-600 shadow-md backdrop-blur-sm z-30">
                        Toplanan Veri: 0
                    </div>
                </div>

                <!-- Table Area -->
                <div class="w-full md:w-1/3 bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col h-full overflow-hidden">
                    <div class="bg-indigo-600 text-white p-3 rounded-t-2xl font-bold text-center shrink-0">
                        ğŸ“‹ SÄ±klÄ±k ve Ã‡etele Tablosu
                    </div>
                    <div class="p-2 overflow-y-auto flex-1">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-sm text-slate-500 border-b-2 border-slate-100 sticky top-0 bg-white">
                                    <th class="p-2">Veri Grubu</th>
                                    <th class="p-2">Ã‡etele</th>
                                    <th class="p-2 text-center">SayÄ±</th>
                                </tr>
                            </thead>
                            <tbody id="tally-body">
                                <!-- Rows generated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-100 shrink-0">
                        <button id="btn-finish-collection" onclick="goToAnalysis()" disabled class="w-full bg-slate-300 text-slate-500 font-bold py-3 rounded-xl transition-all cursor-not-allowed">
                            Veri ToplamayÄ± Bitir & GrafiÄŸe GeÃ§
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PHASE 3: ANALYSIS & GRAPH -->
        <div id="phase-3" class="phase-container flex-col h-full gap-4">
            <div class="text-center shrink-0">
                <h2 class="text-2xl font-bold text-indigo-900">Grafik OluÅŸturma ve Yorumlama</h2>
                <p class="text-slate-600">OluÅŸturduÄŸun grafiÄŸi incele ve dedektif sorularÄ±nÄ± yanÄ±tla.</p>
            </div>

            <div class="flex flex-col md:flex-row gap-6 h-full overflow-hidden">
                <!-- Graph Area -->
                <div class="flex-1 bg-white rounded-2xl shadow-lg p-4 md:p-6 border border-slate-200 flex flex-col min-h-[300px]">
                    <h3 class="text-center font-bold text-lg mb-2 underline decoration-indigo-300 decoration-4" id="chart-title">Grafik BaÅŸlÄ±ÄŸÄ±</h3>
                    
                    <div class="flex-1 flex items-end justify-around border-b-2 border-l-2 border-slate-800 pb-2 pl-2 relative" id="chart-area">
                        <!-- Chart generated by JS -->
                    </div>
                    <div class="flex justify-around pt-2 font-bold text-sm text-slate-600" id="chart-labels">
                        <!-- Labels generated by JS -->
                    </div>
                    <div class="text-center text-xs text-slate-400 mt-2 font-italic" id="x-axis-label">Veri GruplarÄ±</div>
                </div>

                <!-- Question Area -->
                <div class="w-full md:w-1/3 flex flex-col gap-4 overflow-y-auto">
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-2xl p-6 shadow-md relative overflow-hidden shrink-0">
                        <div class="absolute -right-4 -top-4 text-yellow-200 opacity-50 text-9xl">?</div>
                        <div class="flex justify-between items-center relative z-10 mb-2">
                             <h4 class="font-bold text-yellow-800 text-lg">Dedektif Sorusu:</h4>
                             <span id="question-counter" class="bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">Soru 1/5</span>
                        </div>
                       
                        <p id="question-text" class="text-slate-800 font-medium text-lg mb-6 relative z-10">Soru yÃ¼kleniyor...</p>
                        
                        <div id="options-container" class="grid grid-cols-1 gap-2 relative z-10">
                            <!-- Options generated by JS -->
                        </div>

                        <div id="feedback-area" class="hidden relative z-10 mt-4">
                            <div id="feedback-msg" class="p-3 rounded-lg font-bold text-center mb-2"></div>
                            <button id="next-question-btn" onclick="nextQuestion()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg animate-pulse">
                                Sonraki Soru â¤
                            </button>
                             <button id="finish-quiz-btn" onclick="resetSim()" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg">
                                Testi Bitir ve BaÅŸa DÃ¶n â†º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- EXIT CONFIRMATION MODAL -->
    <div id="exit-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center transform transition-all scale-100">
            <div class="text-6xl mb-4">âš ï¸</div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Ã‡Ä±kmak Ä°stediÄŸine Emin Misin?</h3>
            <p class="text-slate-600 mb-6">Åu anki ekranÄ±ndan Ã§Ä±karsan topladÄ±ÄŸÄ±n veriler ve oluÅŸturduÄŸun grafikler <span class="font-bold text-red-500">kaybedilecektir.</span></p>
            
            <div class="flex gap-4 justify-center">
                <button onclick="cancelHomeExit()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition-colors">
                    HayÄ±r, Kal
                </button>
                <button onclick="confirmHomeExit()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition-colors shadow-lg">
                    Evet, Ã‡Ä±k
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const scenarios = {
            // --- KATEGORÄ°K ---
            boardgames: {
                title: "En Sevilen Kutu OyunlarÄ±",
                chartTitle: "Kutu OyunlarÄ± SÃ¼tun GrafiÄŸi",
                xAxis: "Oyunlar",
                options: ["Monopoly", "Uno", "Tabu", "SatranÃ§", "Jenga"],
                emojis: ["ğŸ©", "ğŸƒ", "ğŸ¤«", "â™Ÿï¸", "ğŸ§±"],
                colors: ["#ef4444", "#fbbf24", "#8b5cf6", "#1f2937", "#f97316"]
            },
            sports: {
                title: "En Sevilen Spor DallarÄ±",
                chartTitle: "Spor DallarÄ± SÃ¼tun GrafiÄŸi",
                xAxis: "Spor DallarÄ±",
                options: ["Futbol", "Basketbol", "Voleybol", "YÃ¼zme", "Tenis"],
                emojis: ["âš½", "ğŸ€", "ğŸ", "ğŸŠ", "ğŸ¾"],
                colors: ["#10b981", "#f97316", "#db2777", "#3b82f6", "#84cc16"]
            },
            videogames: {
                title: "En Sevilen Oyun TÃ¼rleri",
                chartTitle: "Oyun TÃ¼rleri GrafiÄŸi",
                xAxis: "Oyun TÃ¼rÃ¼",
                options: ["Macera", "YarÄ±ÅŸ", "Spor", "Bulmaca", "Strateji"],
                emojis: ["âš”ï¸", "ğŸï¸", "âš½", "ğŸ§©", "ğŸ§ "],
                colors: ["#6366f1", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6"]
            },
            icecream: {
                title: "En Sevilen Dondurma",
                chartTitle: "Dondurma Tercihleri GrafiÄŸi",
                xAxis: "Ã‡eÅŸitler",
                options: ["Ã‡ikolata", "Vanilya", "Ã‡ilek", "Limon", "Karamel"],
                emojis: ["ğŸ«", "ğŸ¦", "ğŸ“", "ğŸ‹", "ğŸ®"],
                colors: ["#795548", "#fff9c4", "#f48fb1", "#fff176", "#d7ccc8"]
            },
            pets: {
                title: "Ä°stenen Evcil Hayvan",
                chartTitle: "Evcil Hayvan Tercih GrafiÄŸi",
                xAxis: "Hayvanlar",
                options: ["Kedi", "KÃ¶pek", "KuÅŸ", "BalÄ±k", "Hamster"],
                emojis: ["ğŸ¾", "ğŸ¾", "ğŸ¦", "ğŸŸ", "ğŸ¹"],
                colors: ["#fb923c", "#a8a29e", "#38bdf8", "#60a5fa", "#fde047"]
            },
            holidays: {
                title: "Tatil Tercihi",
                chartTitle: "Tatil Yerleri GrafiÄŸi",
                xAxis: "Yerler",
                options: ["Deniz", "Yaylan", "KÃ¶y", "Åehir", "Kamp"],
                emojis: ["â˜€ï¸", "â›°ï¸", "ğŸ¡", "ğŸ™ï¸", "â›º"],
                colors: ["#38bdf8", "#4ade80", "#a3e635", "#94a3b8", "#fcd34d"]
            },

            // --- NÄ°CEL ---
            toys: {
                title: "Oyuncak SayÄ±sÄ±",
                chartTitle: "Oyuncak SayÄ±sÄ± DaÄŸÄ±lÄ±mÄ±",
                xAxis: "Oyuncak SayÄ±sÄ± AralÄ±ÄŸÄ±",
                options: ["1-5 Tane", "6-10 Tane", "11-15 Tane", "16-20 Tane", "21+ Tane"],
                emojis: ["ğŸ§¸", "ğŸ§¸", "ğŸ§¸", "ğŸ§¸", "ğŸ§¸"],
                colors: ["#bae6fd", "#7dd3fc", "#38bdf8", "#0ea5e9", "#0284c7"]
            },
            screentime: {
                title: "GÃ¼nlÃ¼k Ekran SÃ¼resi",
                chartTitle: "Ekran SÃ¼resi GrafiÄŸi",
                xAxis: "SÃ¼re (Saat)",
                options: ["1 Saat", "2 Saat", "3 Saat", "4 Saat", "5+ Saat"],
                emojis: ["ğŸ“±", "ğŸ“±", "ğŸ“±", "ğŸ“±", "ğŸ“±"],
                colors: ["#86efac", "#4ade80", "#facc15", "#fb923c", "#f87171"]
            },
            siblings: {
                title: "KardeÅŸ SayÄ±sÄ±",
                chartTitle: "KardeÅŸ SayÄ±sÄ± GrafiÄŸi",
                xAxis: "KardeÅŸ SayÄ±sÄ±",
                options: ["0 KardeÅŸ", "1 KardeÅŸ", "2 KardeÅŸ", "3 KardeÅŸ", "4+ KardeÅŸ"],
                emojis: ["ğŸ‘¶", "ğŸ§’", "ğŸ‘¦", "ğŸ‘§", "ğŸ§‘"],
                colors: ["#d8b4fe", "#c084fc", "#a855f7", "#9333ea", "#7e22ce"]
            },
            books: {
                title: "Okunan Kitap SayÄ±sÄ± (AylÄ±k)",
                chartTitle: "Kitap Okuma GrafiÄŸi",
                xAxis: "Kitap SayÄ±sÄ±",
                options: ["1 Kitap", "2 Kitap", "3 Kitap", "4 Kitap", "5+ Kitap"],
                emojis: ["ğŸ“–", "ğŸ“–", "ğŸ“–", "ğŸ“–", "ğŸ“–"],
                colors: ["#fca5a5", "#fdba74", "#fdba74", "#fdba74", "#ef4444"]
            },
            pencils: {
                title: "Kalemlikteki Kalem SayÄ±sÄ±",
                chartTitle: "Kalem SayÄ±sÄ± GrafiÄŸi",
                xAxis: "Kalem SayÄ±sÄ±",
                options: ["1-5", "6-10", "11-15", "16-20", "21+"],
                emojis: ["âœï¸", "âœï¸", "âœï¸", "âœï¸", "âœï¸"],
                colors: ["#e9d5ff", "#d8b4fe", "#c084fc", "#a855f7", "#7e22ce"]
            },
            questions: {
                title: "GÃ¼nlÃ¼k Ã‡Ã¶zÃ¼len Soru SayÄ±sÄ±",
                chartTitle: "Soru Ã‡Ã¶zme GrafiÄŸi",
                xAxis: "Soru SayÄ±sÄ±",
                options: ["10 Soru", "20 Soru", "30 Soru", "40 Soru", "50+ Soru"],
                emojis: ["â“", "â“", "â“", "â“", "ğŸ’¯"],
                colors: ["#bfdbfe", "#93c5fd", "#60a5fa", "#3b82f6", "#2563eb"]
            }
        };

        const levels = {
            easy: { 
                name: "Acemi Dedektif", 
                min: 10, 
                max: 15,
                description: "En az 10, En fazla 15 veri topla." 
            },
            medium: { 
                name: "Uzman Dedektif", 
                min: 15, 
                max: 25,
                description: "En az 15, En fazla 25 veri topla." 
            },
            hard: { 
                name: "BaÅŸ Dedektif", 
                min: 30, 
                max: 40,
                description: "En az 30, En fazla 40 veri topla." 
            }
        };

        let currentScenario = null;
        let currentLevel = null;
        let dataCounts = {}; 
        let totalCollected = 0;

        // Quiz State
        let quizQueue = [];
        let currentQuestionIndex = 0;
        let score = 0;

        // --- NAVIGATION LOGIC ---
        
        function goHomeSafe() {
            // Check if user is in Phase 2 (Data Collection) or Phase 3 (Analysis)
            const isPhase2 = document.getElementById('phase-2').classList.contains('active');
            const isPhase3 = document.getElementById('phase-3').classList.contains('active');
            
            if (isPhase2 || isPhase3) {
                // Show warning modal
                document.getElementById('exit-modal').classList.remove('hidden');
            } else {
                // Phase 0 or 1, safe to go back to start
                resetSim();
            }
        }

        function confirmHomeExit() {
            document.getElementById('exit-modal').classList.add('hidden');
            resetSim();
        }

        function cancelHomeExit() {
            document.getElementById('exit-modal').classList.add('hidden');
        }

        // --- PHASE 0: LEVEL SELECTION ---
        function selectLevel(lvl) {
            currentLevel = levels[lvl];
            currentLevel.id = lvl;
            document.getElementById('level-instruction').innerText = currentLevel.description;
            switchPhase(1);
            document.getElementById('progress-indicator').innerText = `AÅŸama: Konu SeÃ§imi (${currentLevel.name})`;
        }

        // --- PHASE 1: SCENARIO SELECTION ---
        function selectScenario(type) {
            currentScenario = scenarios[type];
            dataCounts = {};
            currentScenario.options.forEach(opt => dataCounts[opt] = 0);
            totalCollected = 0;

            // Setup Table
            const tbody = document.getElementById('tally-body');
            tbody.innerHTML = '';
            currentScenario.options.forEach(opt => {
                const safeId = opt.replace(/[^a-zA-Z0-9]/g, '');
                tbody.innerHTML += `
                    <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                        <td class="p-2 font-medium text-sm md:text-base">${opt}</td>
                        <td class="p-2 tally-text text-lg" id="tally-${safeId}"></td>
                        <td class="p-2 text-center font-bold text-indigo-600" id="count-${safeId}">0</td>
                    </tr>
                `;
            });

            // Generate Students
            const container = document.getElementById('student-container');
            container.innerHTML = '';
            for(let i=0; i<9; i++) {
                addStudentToGrid(i);
            }

            document.getElementById('progress-indicator').innerText = `AÅŸama: Veri Toplama (${currentLevel.name})`;
            switchPhase(2);
            updateCollectionStatus();
        }

        function addStudentToGrid(index) {
            const container = document.getElementById('student-container');
            const student = document.createElement('div');
            
            // Simplified, clear face emojis
            const avatars = ['ğŸ™‚', 'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ‘¦', 'ğŸ‘§'];
            const avatar = avatars[Math.floor(Math.random() * avatars.length)];

            student.className = "character flex flex-col items-center group relative";
            student.innerHTML = `
                <div class="speech-bubble mb-2 opacity-0 group-hover:opacity-100 transition-opacity text-xs font-bold whitespace-nowrap absolute -top-8 w-max z-20 pointer-events-none">
                    Bana sor!
                </div>
                <div class="text-5xl bg-white rounded-full p-2 shadow-sm border-2 border-transparent hover:border-indigo-400 transition-all cursor-pointer select-none transform active:scale-95">${avatar}</div>
            `;
            student.onclick = () => collectData(student);
            container.appendChild(student);
        }

        // --- PHASE 2: COLLECTION ---
        function collectData(element) {
            if (totalCollected >= currentLevel.max) return;
            if (element.classList.contains('disabled')) return;

            const opts = currentScenario.options;
            const randIndex = Math.floor(Math.random() * opts.length);
            const answer = opts[randIndex];
            const emoji = currentScenario.emojis[randIndex];

            dataCounts[answer]++;
            totalCollected++;

            element.classList.add('disabled');
            element.querySelector('.speech-bubble').innerText = answer;
            element.querySelector('.speech-bubble').style.opacity = '1';
            element.querySelector('.text-5xl').innerText = emoji; 
            element.querySelector('.text-5xl').classList.add('bg-indigo-50');

            const safeId = answer.replace(/[^a-zA-Z0-9]/g, '');
            document.getElementById(`count-${safeId}`).innerText = dataCounts[answer];
            
            let marks = "";
            const count = dataCounts[answer];
            for(let i=0; i<count; i++) {
                if((i+1) % 5 === 0) marks += "/ "; 
                else marks += "|";
            }
            document.getElementById(`tally-${safeId}`).innerText = marks;

            updateCollectionStatus();

            if(totalCollected < currentLevel.max && document.querySelectorAll('.character:not(.disabled)').length < 3) {
                 setTimeout(() => {
                    const container = document.getElementById('student-container');
                    container.innerHTML = '';
                    for(let i=0; i<9; i++) addStudentToGrid(i);
                 }, 600);
            }
        }

        function updateCollectionStatus() {
            const statusDiv = document.getElementById('collection-status');
            statusDiv.innerText = `Toplanan Veri: ${totalCollected} / ${currentLevel.max}`;
            
            const btn = document.getElementById('btn-finish-collection');
            if(totalCollected >= currentLevel.min) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
                btn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'shadow-lg', 'animate-pulse');
                btn.innerText = "GrafiÄŸi OluÅŸtur â¤";
            } else {
                 btn.disabled = true;
                 btn.classList.add('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
                 btn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white', 'shadow-lg', 'animate-pulse');
                 btn.innerText = `En az ${currentLevel.min} Veri Gerekli`;
            }
        }

        // --- PHASE 3: ANALYSIS & QUIZ ---
        function goToAnalysis() {
            document.getElementById('progress-indicator').innerText = `AÅŸama: Analiz (${currentLevel.name})`;
            switchPhase(3);
            renderChart();
            startQuiz();
        }

        function renderChart() {
            const chartArea = document.getElementById('chart-area');
            const labelArea = document.getElementById('chart-labels');
            const title = document.getElementById('chart-title');
            const xAxisLabel = document.getElementById('x-axis-label');

            title.innerText = currentScenario.chartTitle;
            xAxisLabel.innerText = currentScenario.xAxis;
            chartArea.innerHTML = '';
            labelArea.innerHTML = '';

            const maxVal = Math.max(...Object.values(dataCounts));
            const scale = maxVal > 0 ? maxVal : 1; 

            currentScenario.options.forEach((opt, index) => {
                const count = dataCounts[opt];
                const heightPercent = (count / scale) * 90; 

                const barCol = document.createElement('div');
                barCol.className = "flex flex-col justify-end items-center h-full w-full mx-1 md:mx-2 group";
                
                const bar = document.createElement('div');
                bar.style.height = "0%"; 
                bar.style.backgroundColor = currentScenario.colors[index];
                bar.className = "w-full rounded-t-md shadow-md bar opacity-90 relative";
                
                if(count > 0) {
                     const innerLabel = document.createElement('span');
                     innerLabel.className = "absolute -top-6 left-1/2 transform -translate-x-1/2 font-bold text-slate-600 text-xs md:text-sm";
                     innerLabel.innerText = count;
                     bar.appendChild(innerLabel);
                }

                barCol.appendChild(bar);
                chartArea.appendChild(barCol);

                const label = document.createElement('div');
                label.className = "w-full text-center px-1 truncate text-[10px] md:text-xs font-medium pt-1";
                label.title = opt; 
                label.innerText = opt;
                labelArea.appendChild(label);

                setTimeout(() => {
                    bar.style.height = `${Math.max(heightPercent, 2)}%`; 
                }, 100);
            });
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            quizQueue = generateQuestions();
            showQuestion(0);
        }

        function generateQuestions() {
            const entries = Object.entries(dataCounts); 
            entries.sort((a, b) => b[1] - a[1]); // Descending sort

            const maxItem = entries[0];
            const minItem = entries[entries.length - 1];
            
            let pool = [];

            // --- QUESTION TYPES based on Level ---

            // Type 1: MODE (Easy, Medium, Hard)
            pool.push({
                text: `GrafiÄŸe gÃ¶re, "${currentScenario.title}" araÅŸtÄ±rmasÄ±nda en yÃ¼ksek deÄŸer (mod) hangisidir?`,
                correct: maxItem[0],
                type: 'categorical'
            });

            // Type 2: MIN (Easy, Medium, Hard)
            pool.push({
                text: `GrafiÄŸe gÃ¶re, en az tercih edilen seÃ§enek hangisidir?`,
                correct: minItem[0],
                type: 'categorical'
            });

            // Type 3: Specific Count (Easy, Medium, Hard)
            const randomOpt = entries[Math.floor(Math.random()*entries.length)];
            pool.push({
                text: `Sadece "${randomOpt[0]}" cevabÄ±nÄ± veren kaÃ§ kiÅŸi vardÄ±r?`,
                correct: randomOpt[1].toString(),
                type: 'numeric'
            });

            if (currentLevel.id !== 'easy') {
                 // Type 4: Total (Medium, Hard)
                pool.push({
                    text: "Bu araÅŸtÄ±rma iÃ§in toplam kaÃ§ kiÅŸiden veri toplanmÄ±ÅŸtÄ±r?",
                    correct: totalCollected.toString(),
                    type: 'numeric'
                });

                // Type 5: Sum of Two (Medium, Hard)
                const opt1 = entries[Math.floor(Math.random()*entries.length)];
                let opt2 = entries[Math.floor(Math.random()*entries.length)];
                while(opt1[0] === opt2[0]) {
                    opt2 = entries[Math.floor(Math.random()*entries.length)];
                }
                const sum2 = opt1[1] + opt2[1];
                pool.push({
                    text: `"${opt1[0]}" ve "${opt2[0]}" diyenlerin toplam sayÄ±sÄ± kaÃ§tÄ±r?`,
                    correct: sum2.toString(),
                    type: 'numeric'
                });
            }

            if (currentLevel.id === 'hard') {
                 // Type 6: Difference (Hard) - More complex
                if(maxItem[1] !== minItem[1]) {
                    const diff = maxItem[1] - minItem[1];
                    pool.push({
                        text: `En Ã§ok tercih edilen seÃ§enek, en az tercih edilen seÃ§enekten sayÄ±ca kaÃ§ fazladÄ±r?`,
                        correct: diff.toString(),
                        type: 'numeric'
                    });
                }
                
                // Type 7: Multi-step arithmetic (Hard)
                // (Option A + Option B) - Option C
                // Pick 3 random distinct options
                if(entries.length >= 3) {
                     const opts = [...entries].sort(() => Math.random() - 0.5).slice(0, 3);
                     const res = (opts[0][1] + opts[1][1]) - opts[2][1];
                     // Only add if result is positive to avoid confusion
                     if (res >= 0) {
                        pool.push({
                            text: `"${opts[0][0]}" ve "${opts[1][0]}" diyenlerin toplamÄ±ndan, "${opts[2][0]}" diyenleri Ã§Ä±karÄ±rsak sonuÃ§ kaÃ§ olur?`,
                            correct: res.toString(),
                            type: 'numeric'
                        });
                     }
                }

                // Type 8: Sum of Top 2 (Hard)
                pool.push({
                    text: `En Ã§ok tercih edilen ilk iki seÃ§eneÄŸin toplamÄ± kaÃ§tÄ±r?`,
                    correct: (entries[0][1] + entries[1][1]).toString(),
                    type: 'numeric'
                });
            }

            // Fill up to 5 questions
            while(pool.length < 5) {
                // Add a random existing type again (simple variation logic)
                 const randomQ = pool[Math.floor(Math.random() * pool.length)];
                 pool.push({...randomQ});
            }

            // Shuffle
            pool.sort(() => Math.random() - 0.5);
            return pool.slice(0, 5);
        }

        function showQuestion(index) {
            const q = quizQueue[index];
            const qCounter = document.getElementById('question-counter');
            const qText = document.getElementById('question-text');
            const optContainer = document.getElementById('options-container');
            const feedbackArea = document.getElementById('feedback-area');
            
            qCounter.innerText = `Soru ${index + 1} / ${quizQueue.length}`;
            qText.innerText = q.text;
            
            // Reset UI
            optContainer.innerHTML = '';
            feedbackArea.classList.add('hidden');
            document.getElementById('next-question-btn').classList.add('hidden');
            document.getElementById('finish-quiz-btn').classList.add('hidden');

            // Generate 5 Options (1 Correct + 4 Wrong)
            let options = [];
            options.push(q.correct);

            if(q.type === 'categorical') {
                const correctCount = dataCounts[q.correct];
                currentScenario.options.forEach(opt => {
                    // Sadece doÄŸru cevap olmayan VE doÄŸru cevapla AYNI DEÄERE sahip olmayanlarÄ± ekle
                    // BÃ¶ylece eÅŸit deÄŸerli (tied) ÅŸÄ±klar elenir, tek doÄŸru cevap kalÄ±r
                    if(opt !== q.correct && !options.includes(opt)) {
                        if(dataCounts[opt] !== correctCount) {
                             options.push(opt);
                        }
                    }
                });
                options = options.slice(0, 5);
            } else {
                const correctNum = parseInt(q.correct);
                const wrongs = new Set();
                let attempts = 0;
                while(wrongs.size < 4 && attempts < 50) {
                    attempts++;
                    const offset = Math.floor(Math.random() * 9) - 4; 
                    const val = correctNum + offset;
                    if(val >= 0 && val !== correctNum) {
                        wrongs.add(val.toString());
                    }
                }
                while(wrongs.size < 4) wrongs.add((correctNum + wrongs.size + 1).toString());
                
                options.push(...wrongs);
            }

            options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 border-indigo-100 hover:border-indigo-400 text-indigo-800 font-bold py-2 rounded-xl transition-all shadow-sm text-sm md:text-base text-left px-4";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt, q.correct, btn);
                optContainer.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btnElement) {
            const allBtns = document.querySelectorAll('#options-container button');
            allBtns.forEach(b => b.disabled = true);

            const feedbackArea = document.getElementById('feedback-area');
            const feedbackMsg = document.getElementById('feedback-msg');
            feedbackArea.classList.remove('hidden');

            if(selected === correct) {
                score++;
                btnElement.classList.add('bg-green-500', 'text-white', 'border-green-600');
                feedbackMsg.className = "p-3 rounded-lg font-bold text-center mb-2 bg-green-100 text-green-700";
                feedbackMsg.innerHTML = "ğŸ‰ DoÄŸru Cevap!";
            } else {
                btnElement.classList.add('bg-red-500', 'text-white', 'border-red-600');
                feedbackMsg.className = "p-3 rounded-lg font-bold text-center mb-2 bg-red-100 text-red-700";
                feedbackMsg.innerHTML = `âš ï¸ YanlÄ±ÅŸ! DoÄŸru cevap: <strong>${correct}</strong>`;
                
                allBtns.forEach(b => {
                    if(b.innerText === correct) b.classList.add('bg-green-200', 'border-green-400');
                });
            }

            if(currentQuestionIndex < quizQueue.length - 1) {
                document.getElementById('next-question-btn').classList.remove('hidden');
            } else {
                const finishBtn = document.getElementById('finish-quiz-btn');
                finishBtn.classList.remove('hidden');
                finishBtn.innerHTML = `Testi Bitir (Skor: ${score}/${quizQueue.length}) â†º`;
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        }

        function switchPhase(phaseNum) {
            document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`phase-${phaseNum}`).classList.add('active');
        }

        function resetSim() {
            switchPhase(0); // Go back to Level Selection
            document.getElementById('progress-indicator').innerText = "AÅŸama: Seviye SeÃ§imi";
            document.getElementById('btn-finish-collection').disabled = true;
            document.getElementById('btn-finish-collection').classList.add('bg-slate-300');
            document.getElementById('btn-finish-collection').classList.remove('bg-green-500', 'animate-pulse');
            document.getElementById('feedback-area').classList.add('hidden');
        }

    </script>
</body>
</html>