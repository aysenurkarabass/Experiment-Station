<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5. Sınıf Geometri Laboratuvarı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e2e8f0; 
            overscroll-behavior: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        
        #app-frame {
            width: 940px;
            height: 520px;
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 0.75rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        canvas {
            cursor: crosshair;
            background-color: #ffffff;
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: -1px -1px;
            touch-action: none;
        }
        .tool-btn {
            transition: all 0.2s;
        }
        .tool-btn.active {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #2563eb;
        }
        .tool-group-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
            width: 100%;
            text-align: center;
            font-weight: 700;
        }

        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

    <div id="app-frame">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-3 shadow-sm z-20 shrink-0">
            <div class="flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <!-- Logo -->
                    <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" onerror="this.src='https://placehold.co/40x40?text=E12'" alt="E12 Logo" class="h-10 w-auto object-contain">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800 leading-tight">Geometri Laboratuvarı</h1>
                        <p class="text-[10px] text-gray-500">5. Sınıf: Çizimler, Açılar ve Çemberler</p>
                    </div>
                </div>
                
                <div class="hidden md:flex flex-1 mx-8 justify-center">
                     <div class="text-xs text-blue-800 bg-blue-50 px-4 py-1.5 rounded-full border border-blue-100 flex items-center shadow-sm whitespace-nowrap overflow-hidden text-ellipsis max-w-[400px]">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        <span id="instruction-text" class="font-medium truncate">Bir araç seçin ve çizim alanına tıklayın.</span>
                    </div>
                </div>
    
                <div class="flex gap-2">
                    <button onclick="toggleHelp()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border border-blue-200 flex items-center gap-2">
                        <i class="fas fa-question-circle"></i> Yardım
                    </button>
                    <button onclick="clearCanvas()" class="bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border border-red-200 flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> Temizle
                    </button>
                </div>
            </div>
        </header>
    
        <!-- Main Content -->
        <div class="flex flex-1 relative overflow-hidden">
            
            <!-- Sidebar Tools -->
            <div class="w-16 md:w-20 bg-white border-r border-gray-200 flex flex-col items-center py-2 gap-2 z-10 shadow-lg overflow-y-auto scrollbar-hide">
                
                <div class="tool-group-label mt-2">Temel</div>
                
                <button onclick="setTool('point')" id="btn-point" class="tool-btn active w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-circle text-[8px]"></i>
                    <span class="text-[8px] font-bold">Nokta</span>
                </button>
    
                <button onclick="setTool('segment')" id="btn-segment" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-grip-lines text-xs"></i>
                    <span class="text-[8px] font-bold">Çizgi</span>
                </button>
    
                <button onclick="setTool('line')" id="btn-line" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-arrows-alt-h text-xs"></i>
                    <span class="text-[8px] font-bold">Doğru</span>
                </button>
    
                 <button onclick="setTool('ray')" id="btn-ray" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-long-arrow-alt-right text-xs"></i>
                    <span class="text-[8px] font-bold">Işın</span>
                </button>
    
                <div class="tool-group-label">Şekil</div>
    
                <button onclick="setTool('angle')" id="btn-angle" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-chart-pie text-xs"></i>
                    <span class="text-[8px] font-bold">Açı</span>
                </button>
    
                <button onclick="setTool('polygon')" id="btn-polygon" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="fas fa-draw-polygon text-xs"></i>
                    <span class="text-[8px] font-bold">Çokgen</span>
                </button>
    
                <button onclick="setTool('circle')" id="btn-circle" class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 flex flex-col items-center justify-center gap-0.5 border border-gray-200">
                    <i class="far fa-circle text-xs"></i>
                    <span class="text-[8px] font-bold">Çember</span>
                </button>
    
                <div class="h-px w-8 bg-gray-200 my-1"></div>
    
                <button onclick="undo()" class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 flex flex-col items-center justify-center gap-0.5 border border-red-100 transition-colors">
                    <i class="fas fa-undo text-xs"></i>
                    <span class="text-[8px] font-bold">Geri</span>
                </button>
    
            </div>
    
            <!-- Canvas Area -->
            <div class="flex-1 relative bg-gray-50 overflow-hidden" id="canvas-container">
                <canvas id="geometryCanvas" class="absolute top-0 left-0"></canvas>
                
                <!-- Info Box -->
                <div id="info-box" class="absolute bottom-6 right-6 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-xl border border-blue-100 max-w-[200px] hidden pointer-events-none transform transition-all duration-300 translate-y-2">
                    <div class="flex items-start gap-2">
                        <div class="bg-blue-100 p-1.5 rounded-full text-blue-600 mt-0.5">
                            <i class="fas fa-info text-[10px]"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-xs mb-0.5" id="info-title">Bilgi</h3>
                            <p class="text-[10px] text-gray-600 leading-tight" id="info-desc">Açıklama burada.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. INTRO SCREEN (Absolute Overlay) -->
        <div id="intro-screen" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center text-center p-8">
            <div class="mb-6 animate-bounce">
                 <!-- Logo -->
                <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" onerror="this.src='https://placehold.co/100x100?text=E12'" alt="E12 Logo" class="h-24 w-auto object-contain drop-shadow-sm">
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-3">Geometri Laboratuvarına Hoş Geldiniz</h1>
            <p class="text-gray-600 mb-8 max-w-lg leading-relaxed">
                Bu dijital atölyede noktalar, doğrular ve açılarla deneyler yapabilir, kendi şekillerini oluşturabilir ve geometrinin temellerini keşfedebilirsin!
            </p>
            
            <div class="grid grid-cols-2 gap-x-8 gap-y-4 text-left mb-10 w-full max-w-md">
                <div class="flex items-center gap-3">
                    <i class="fas fa-pencil-alt text-blue-500 text-xl w-6 text-center"></i>
                    <span class="text-lg text-gray-700">Çizim Yap</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-search-plus text-purple-500 text-xl w-6 text-center"></i>
                    <span class="text-lg text-gray-700">Keşfet</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-ruler-combined text-green-500 text-xl w-6 text-center"></i>
                    <span class="text-lg text-gray-700">Ölçüm Yap</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-lightbulb text-orange-500 text-xl w-6 text-center"></i>
                    <span class="text-lg text-gray-700">Öğren</span>
                </div>
            </div>

            <button onclick="startSimulation()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-full shadow-lg shadow-blue-200 transform transition hover:scale-105 active:scale-95 flex items-center gap-2 text-lg">
                <span>Hadi Başlayalım</span> <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- 2. HELP MODAL (Absolute Overlay, Hidden by default) -->
        <div id="help-modal" class="absolute inset-0 z-[60] bg-black/40 hidden flex items-center justify-center backdrop-blur-[2px]">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-6 h-[85%] flex flex-col overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                
                <!-- Modal Header -->
                <div class="bg-gray-50 border-b border-gray-100 p-4 flex justify-between items-center shrink-0">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-book-open text-blue-500"></i> Kullanım Rehberi
                    </h2>
                    <button onclick="toggleHelp()" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Modal Content (Scrollable) -->
                <div class="p-6 overflow-y-auto bg-white flex-1">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Sol Kolon -->
                        <div class="space-y-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Temel Araçlar</h3>
                            
                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-circle text-xs"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Nokta</h4>
                                    <p class="text-xs text-gray-600">Ekranın herhangi bir yerine tıkla. Noktalar otomatik olarak (A, B, C...) isimlendirilir.</p>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-grip-lines text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Çizgi (Doğru Parçası)</h4>
                                    <p class="text-xs text-gray-600">Başlangıç noktasına tıkla, fareyi basılı tutarak sürükle ve bitiş noktasında bırak.</p>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-arrows-alt-h text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Doğru</h4>
                                    <p class="text-xs text-gray-600">Sürükleyerek iki nokta belirle. İki yöne sonsuza giden bir çizgi oluşturur.</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-long-arrow-alt-right text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Işın</h4>
                                    <p class="text-xs text-gray-600">Bir noktadan başlayıp tek bir yöne sonsuza giden çizgi. Sürükle ve bırak.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Sağ Kolon -->
                        <div class="space-y-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Şekil Araçları</h3>

                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-chart-pie text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Açı Ölçer</h4>
                                    <p class="text-xs text-gray-600">Sırasıyla 3 noktaya tıkla: <br>1. Merkez Noktası <br>2. Birinci kol üzerindeki nokta <br>3. İkinci kol üzerindeki nokta.</p>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="fas fa-draw-polygon text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Çokgen</h4>
                                    <p class="text-xs text-gray-600">Köşeleri oluşturmak için sırayla tıkla. Şekli kapatmak için en baştaki noktaya tekrar tıkla.</p>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 text-gray-600"><i class="far fa-circle text-sm"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">Çember</h4>
                                    <p class="text-xs text-gray-600">Merkez noktasına tıkla, basılı tutarak yarıçapı ayarla ve bırak.</p>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-100 text-xs text-yellow-800 flex gap-2">
                                <i class="fas fa-info-circle mt-0.5"></i>
                                <span><strong>İpucu:</strong> Hata yaparsan "Geri" butonunu kullanabilir veya "Temizle" ile sayfayı tamamen silebilirsin.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 p-4 border-t border-gray-100 flex justify-end">
                    <button onclick="toggleHelp()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition-colors">
                        Anladım, Kapat
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Yapılandırma ---
        const GRID_SIZE = 40; 
        const POINT_RADIUS = 5;
        const SNAP_THRESHOLD = 15;
        const ALPHABET = "ABCDEFGHIJKLMNOPRSTUVYZ";
        
        // --- Durum Değişkenleri ---
        let currentTool = 'point'; 
        let shapes = []; 
        let tempShape = null; 
        let alphabetIndex = 0;
        
        let isDrawing = false;
        let startPoint = null;
        let polyPoints = []; 
        let anglePoints = []; 

        // --- DOM ---
        const canvas = document.getElementById('geometryCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        const instructionText = document.getElementById('instruction-text');
        const infoBox = document.getElementById('info-box');

        // --- Init ---
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);

        // --- UI Functions ---
        function startSimulation() {
            const intro = document.getElementById('intro-screen');
            intro.style.transition = "opacity 0.5s ease";
            intro.style.opacity = "0";
            setTimeout(() => {
                intro.style.display = "none";
            }, 500);
        }

        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function setTool(tool) {
            currentTool = tool;
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');

            tempShape = null;
            isDrawing = false;
            startPoint = null;
            polyPoints = [];
            anglePoints = [];

            const instructions = {
                'point': 'Kağıda nokta koymak için tıklayın.',
                'segment': 'Doğru parçası çizmek için sürükleyip bırakın.',
                'line': 'Doğru çizmek için iki nokta belirleyin.',
                'ray': 'Işın çizmek için başlangıçtan yöne doğru çekin.',
                'polygon': 'Köşeleri tıklayın. Bitirmek için başlangıç noktasına tıklayın.',
                'circle': 'Merkeze tıklayın, yarıçapı ayarlamak için sürükleyin.',
                'angle': 'Sırasıyla 3 noktaya tıklayın: 1.Köşe(Merkez), 2.Kenar, 3.Kenar.'
            };
            instructionText.innerHTML = instructions[tool];
            draw();
        }

        // --- Matematik & Yardımcılar ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function snapToGrid(pos) {
            const snapX = Math.round(pos.x / GRID_SIZE) * GRID_SIZE;
            const snapY = Math.round(pos.y / GRID_SIZE) * GRID_SIZE;
            const dist = Math.sqrt(Math.pow(pos.x - snapX, 2) + Math.pow(pos.y - snapY, 2));
            return (dist < SNAP_THRESHOLD) ? { x: snapX, y: snapY, snapped: true } : { x: pos.x, y: pos.y, snapped: false };
        }

        function getNextLabel() {
            const label = ALPHABET[alphabetIndex % ALPHABET.length] + (Math.floor(alphabetIndex / ALPHABET.length) || "");
            alphabetIndex++;
            return label;
        }

        function dist(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function calculateAngle(center, p1, p2) {
            const ang1 = Math.atan2(p1.y - center.y, p1.x - center.x);
            const ang2 = Math.atan2(p2.y - center.y, p2.x - center.x);
            let deg = (ang2 - ang1) * 180 / Math.PI;
            if (deg < 0) deg += 360;
            if (deg > 180) deg = 360 - deg;
            return Math.round(deg);
        }

        // Belirtilen koordinatta nokta var mı kontrol et
        function getPointAt(pos) {
            return shapes.find(s => s.type === 'point' && Math.abs(s.x - pos.x) < 1 && Math.abs(s.y - pos.y) < 1);
        }

        // --- Event Handlers ---
        function handleStart(rawPos) {
            const pos = snapToGrid(rawPos);

            if (currentTool === 'point') {
                addPoint(pos);
            } 
            else if (currentTool === 'angle') {
                anglePoints.push(pos);
                shapes.push({ type: 'temp_dot', x: pos.x, y: pos.y }); 
                
                if (anglePoints.length === 1) {
                    instructionText.innerText = "Şimdi 1. kenar üzerindeki noktaya tıklayın.";
                } else if (anglePoints.length === 2) {
                    instructionText.innerText = "Son olarak 2. kenar üzerindeki noktaya tıklayın.";
                } else if (anglePoints.length === 3) {
                    const deg = calculateAngle(anglePoints[0], anglePoints[1], anglePoints[2]);
                    shapes = shapes.filter(s => s.type !== 'temp_dot'); 
                    shapes.push({
                        type: 'angle',
                        center: anglePoints[0],
                        p1: anglePoints[1],
                        p2: anglePoints[2],
                        deg: deg
                    });
                    showInfo(`Açı Ölçümü`, `Oluşan açı: ${deg} derece.`);
                    anglePoints = [];
                    setTool('angle'); 
                }
            }
            else if (currentTool === 'polygon') {
                if (polyPoints.length > 0) {
                    const startP = polyPoints[0];
                    if (dist(pos, startP) < SNAP_THRESHOLD) {
                        if (polyPoints.length >= 3) {
                            shapes.push({
                                type: 'polygon',
                                points: [...polyPoints]
                            });
                            showInfo('Çokgen', `${polyPoints.length} kenarlı bir çokgen çizdiniz.`);
                        }
                        polyPoints = [];
                        tempShape = null;
                        return;
                    }
                }
                polyPoints.push(pos);
            }
            else {
                isDrawing = true;
                startPoint = pos;
                tempShape = {
                    type: currentTool,
                    start: startPoint,
                    end: startPoint
                };
            }
            draw();
        }

        function handleMove(rawPos) {
            const pos = snapToGrid(rawPos);

            if (currentTool === 'polygon' && polyPoints.length > 0) {
                tempShape = {
                    type: 'poly_ghost',
                    start: polyPoints[polyPoints.length - 1],
                    end: pos
                };
                draw();
                return;
            }

            if (!isDrawing) return;
            tempShape.end = pos;
            draw();
        }

        function handleEnd() {
            if (!isDrawing) return;
            if (dist(tempShape.start, tempShape.end) < 5) {
                isDrawing = false;
                tempShape = null;
                draw();
                return;
            }

            if (currentTool === 'circle') {
                shapes.push({
                    type: 'circle',
                    center: tempShape.start,
                    radiusP: tempShape.end,
                    r: dist(tempShape.start, tempShape.end)
                });
                
                // Merkezde zaten nokta yoksa ekle
                if (!getPointAt(tempShape.start)) {
                     shapes.push({ type: 'point', x: tempShape.start.x, y: tempShape.start.y, label: getNextLabel() });
                }

                showInfo('Çember', 'Merkeze eşit uzaklıktaki noktalar kümesi.');
            }
            else {
                // Başlangıç Noktası Kontrolü
                let startP = getPointAt(tempShape.start);
                let p1Label;
                if (startP) {
                    p1Label = startP.label; // Mevcut etiketi kullan
                } else {
                    p1Label = getNextLabel();
                    shapes.push({ type: 'point', x: tempShape.start.x, y: tempShape.start.y, label: p1Label });
                }

                // Bitiş Noktası Kontrolü
                let endP = getPointAt(tempShape.end);
                let p2Label;
                if (endP) {
                    p2Label = endP.label; // Mevcut etiketi kullan
                } else {
                    p2Label = getNextLabel();
                    shapes.push({ type: 'point', x: tempShape.end.x, y: tempShape.end.y, label: p2Label });
                }

                shapes.push({ ...tempShape, labels: [p1Label, p2Label] });
                if(currentTool === 'segment') showInfo('Doğru Parçası', `Uzunluğu ölçülebilen parça. [${p1Label}${p2Label}]`);
            }

            isDrawing = false;
            tempShape = null;
            startPoint = null;
            draw();
        }

        function addPoint(pos) {
            // Eğer orada zaten nokta varsa ekleme
            if (getPointAt(pos)) return;

            shapes.push({
                type: 'point',
                x: pos.x,
                y: pos.y,
                label: getNextLabel()
            });
            draw();
        }

        // Event Listeners
        canvas.addEventListener('mousedown', e => handleStart(getMousePos(e)));
        canvas.addEventListener('mousemove', e => handleMove(getMousePos(e)));
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(getMousePos(e)); }, {passive: false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(getMousePos(e)); }, {passive: false});
        window.addEventListener('touchend', handleEnd);

        // --- Çizim Motoru ---
        function drawArrow(fromx, fromy, tox, toy) {
            const headlen = 10;
            const angle = Math.atan2(toy - fromy, tox - fromx);
            ctx.beginPath();
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function drawShape(s, isPreview = false) {
            ctx.strokeStyle = isPreview ? '#3b82f6' : '#1e40af';
            ctx.lineWidth = isPreview ? 2 : 3;
            ctx.lineCap = 'round';
            ctx.fillStyle = '#1e40af';

            if (s.type === 'circle') {
                ctx.beginPath();
                let r = s.r;
                if (isPreview) r = dist(s.start, s.end);
                ctx.arc(s.center ? s.center.x : s.start.x, s.center ? s.center.y : s.start.y, r, 0, 2 * Math.PI);
                ctx.strokeStyle = isPreview ? 'rgba(59, 130, 246, 0.6)' : '#2563eb';
                ctx.stroke();
                if(isPreview) {
                    ctx.beginPath();
                    ctx.moveTo(s.start.x, s.start.y);
                    ctx.lineTo(s.end.x, s.end.y);
                    ctx.setLineDash([5, 5]);
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                return;
            }

            if (s.type === 'polygon') {
                ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
                ctx.beginPath();
                ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let i=1; i<s.points.length; i++) ctx.lineTo(s.points[i].x, s.points[i].y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#1e40af';
                s.points.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, 2*Math.PI);
                    ctx.fill();
                });
                return;
            }
            
            if (s.type === 'poly_ghost') {
                ctx.beginPath();
                ctx.moveTo(s.start.x, s.start.y);
                ctx.lineTo(s.end.x, s.end.y);
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
                return;
            }

            if (s.type === 'angle') {
                ctx.save();
                ctx.strokeStyle = 'rgba(245, 158, 11, 0.8)'; 
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(s.p1.x, s.p1.y);
                ctx.lineTo(s.center.x, s.center.y);
                ctx.lineTo(s.p2.x, s.p2.y);
                ctx.stroke();
                
                const radius = 30;
                const startAngle = Math.atan2(s.p1.y - s.center.y, s.p1.x - s.center.x);
                const endAngle = Math.atan2(s.p2.y - s.center.y, s.p2.x - s.center.x);
                ctx.beginPath();
                ctx.arc(s.center.x, s.center.y, radius, startAngle, endAngle, false); 
                ctx.fillStyle = 'rgba(245, 158, 11, 0.2)';
                ctx.lineTo(s.center.x, s.center.y);
                ctx.fill();
                ctx.font = "bold 14px sans-serif";
                ctx.fillStyle = "#b45309";
                ctx.fillText(s.deg + "°", s.center.x + 10, s.center.y - 10);
                ctx.restore();
                return;
            }
            
            if (s.type === 'point' || s.type === 'temp_dot') {
                ctx.beginPath();
                ctx.arc(s.x, s.y, POINT_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = (s.type === 'temp_dot') ? '#f59e0b' : '#1d4ed8';
                ctx.fill();
                if (s.label) {
                    ctx.font = "bold 16px sans-serif";
                    ctx.fillStyle = "#111827";
                    ctx.fillText(s.label, s.x + 8, s.y - 8);
                }
                return;
            }

            const d = dist(s.start, s.end);
            if (d < 1) return;

            let startDraw = { ...s.start };
            let endDraw = { ...s.end };
            const extension = 1000;

            if (s.type === 'line') {
                const ratio = extension / d;
                const dx = s.end.x - s.start.x;
                const dy = s.end.y - s.start.y;
                startDraw.x -= dx * ratio;
                startDraw.y -= dy * ratio;
                endDraw.x += dx * ratio;
                endDraw.y += dy * ratio;
            } else if (s.type === 'ray') {
                const ratio = extension / d;
                const dx = s.end.x - s.start.x;
                const dy = s.end.y - s.start.y;
                endDraw.x += dx * ratio;
                endDraw.y += dy * ratio;
            }

            ctx.beginPath();
            ctx.moveTo(startDraw.x, startDraw.y);
            ctx.lineTo(endDraw.x, endDraw.y);
            ctx.stroke();

            if (!isPreview) {
                const dx = s.end.x - s.start.x;
                const dy = s.end.y - s.start.y;
                const unitX = dx/d;
                const unitY = dy/d;

                if (s.type === 'ray') {
                     drawArrow(s.start.x, s.start.y, s.end.x + unitX * 25, s.end.y + unitY * 25);
                } else if (s.type === 'line') {
                    drawArrow(s.start.x, s.start.y, s.end.x + unitX * 25, s.end.y + unitY * 25);
                    drawArrow(s.end.x, s.end.y, s.start.x - unitX * 25, s.start.y - unitY * 25);
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const layers = {
                bottom: shapes.filter(s => ['circle', 'polygon', 'angle'].includes(s.type)),
                mid: shapes.filter(s => ['segment', 'line', 'ray'].includes(s.type)),
                top: shapes.filter(s => ['point', 'temp_dot'].includes(s.type))
            };
            layers.bottom.forEach(s => drawShape(s));
            layers.mid.forEach(s => drawShape(s));
            if (tempShape) drawShape(tempShape, true);
            if (polyPoints.length > 0) {
                polyPoints.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, 2*Math.PI);
                    ctx.fillStyle = '#3b82f6';
                    ctx.fill();
                });
                if (polyPoints.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                    for(let i=1; i<polyPoints.length; i++) ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                    ctx.strokeStyle = '#3b82f6';
                    ctx.stroke();
                }
            }
            if (anglePoints.length > 0) {
                anglePoints.forEach(p => {
                     ctx.beginPath();
                     ctx.arc(p.x, p.y, 4, 0, 2*Math.PI);
                     ctx.fillStyle = '#f59e0b';
                     ctx.fill();
                });
            }
            layers.top.forEach(s => drawShape(s));
        }

        function undo() {
            if (shapes.length > 0) {
                const last = shapes[shapes.length - 1];
                if (!last) return;
                if (last.type === 'point' || last.type === 'angle' || last.type === 'polygon') {
                    shapes.pop();
                    if(last.label) alphabetIndex--;
                } else if (last.type === 'circle') {
                    shapes.pop(); shapes.pop();
                    alphabetIndex--;
                } else {
                    shapes.pop(); shapes.pop(); shapes.pop(); 
                    alphabetIndex -= 2;
                }
                draw();
            }
        }

        function clearCanvas() {
            shapes = [];
            alphabetIndex = 0;
            polyPoints = [];
            anglePoints = [];
            setTool('point');
            infoBox.classList.add('hidden');
        }

        function showInfo(title, desc) {
            const titleEl = document.getElementById('info-title');
            const descEl = document.getElementById('info-desc');
            titleEl.textContent = title;
            descEl.textContent = desc;
            infoBox.classList.remove('hidden');
            infoBox.classList.remove('opacity-0');
            infoBox.classList.remove('translate-y-2');
            setTimeout(() => {
                infoBox.classList.add('opacity-0');
                infoBox.classList.add('translate-y-2');
            }, 6000);
        }

        setTimeout(resizeCanvas, 100);
        setTool('point');

    </script>
</body>
</html>