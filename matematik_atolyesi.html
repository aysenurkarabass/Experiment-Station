<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5. SÄ±nÄ±f Matematik Ã‡izim AtÃ¶lyesi</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&subset=latin,latin-ext&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626', 
                            700: '#b91c1c',
                            800: '#991b1b',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }

        #canvas-container {
            cursor: crosshair;
            background-color: #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .tool-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .tool-btn:active { transform: scale(0.95); }
        
        .tool-btn.active {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #b91c1c;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1);
        }
        .tool-btn.active::after {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background-color: #dc2626;
        }

        .color-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #d1d5db;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active {
            box-shadow: 0 0 0 2px #dc2626, 0 0 0 4px white;
            transform: scale(1.1);
        }

        .grid-bg {
            background-size: 20px 20px;
            background-image: 
                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
        }
        .grid-bg-none { background-image: none; }

        #intro-screen {
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #intro-screen.hidden-intro {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .modal-content {
            transition: all 0.3s ease-out;
        }

        /* GÃ¶rev KartÄ± Animasyonu */
        #task-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .hidden-card {
            transform: translateY(-150%) translateX(-50%);
            opacity: 0;
        }
        .visible-card {
            transform: translateY(0) translateX(-50%);
            opacity: 1;
        }
        
        .feedback-success { color: #16a34a; font-weight: bold; }
        .feedback-error { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row p-2 md:p-4 gap-4 relative">

    <!-- GiriÅŸ EkranÄ± (Intro Screen) -->
    <div id="intro-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="max-w-2xl w-full bg-white">
            <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" alt="e12 Logosu" class="h-20 mx-auto mb-8 object-contain">
            <h1 class="text-3xl md:text-4xl font-bold text-brand-700 mb-4">Matematik Ã‡izim AtÃ¶lyesi</h1>
            <p class="text-gray-600 mb-8 text-lg">Ä°nternet baÄŸlantÄ±sÄ± gerektirmeyen, akÄ±llÄ± Ã§izim araÃ§larÄ±.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-left">
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 flex flex-col items-center text-center">
                    <span class="text-4xl mb-3">ğŸ“</span>
                    <h3 class="font-bold text-blue-800">Cetvel</h3>
                    <p class="text-xs text-blue-600">Uzunluk Ã¶lÃ§me</p>
                </div>
                <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 flex flex-col items-center text-center">
                    <span class="text-4xl mb-3">ğŸ“</span>
                    <h3 class="font-bold text-orange-800">AÃ§Ä±Ã¶lÃ§er</h3>
                    <p class="text-xs text-orange-600">AÃ§Ä± Ã§izme</p>
                </div>
                <div class="bg-purple-50 p-5 rounded-xl border border-purple-100 flex flex-col items-center text-center">
                    <span class="text-4xl mb-3">ğŸ“</span>
                    <h3 class="font-bold text-purple-800">Pergel</h3>
                    <p class="text-xs text-purple-600">Ã‡ember Ã§izme</p>
                </div>
            </div>

            <button onclick="startSimulation()" class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-brand-600 font-lg rounded-full hover:bg-brand-700 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-brand-500">
                AtÃ¶lyeye Gir
            </button>
        </div>
        <div class="absolute bottom-6 text-xs text-gray-400">
            5. SÄ±nÄ±f Matematik - Geometrik Ã‡izimler (Ã‡evrimdÄ±ÅŸÄ± SÃ¼rÃ¼m)
        </div>
    </div>

    <!-- Silme Onay ModalÄ± -->
    <div id="delete-modal" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm flex flex-col overflow-hidden transform transition-all scale-95 modal-content" id="delete-modal-content">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ğŸ—‘ï¸</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">SayfayÄ± Temizle</h3>
                <p class="text-gray-600">TÃ¼m Ã§izimler silinecek.</p>
            </div>
            <div class="bg-gray-50 p-4 flex gap-3 justify-center border-t border-gray-100">
                <button onclick="closeDeleteModal()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-xl font-bold transition-colors">Ä°ptal</button>
                <button onclick="performClearCanvas()" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-colors shadow-lg">Evet, Sil</button>
            </div>
        </div>
    </div>

    <!-- Sidebar (AraÃ§lar) -->
    <div class="flex flex-col gap-4 w-full md:w-64 bg-white rounded-2xl shadow-lg p-4 h-auto md:h-full overflow-y-auto z-10">
        
        <div class="text-center pb-4 border-b border-gray-100 flex flex-col items-center">
            <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" alt="e12 Logosu" class="h-12 mb-2 object-contain">
            <h1 class="text-lg font-bold text-brand-800">Ã‡izim AtÃ¶lyesi</h1>
        </div>

        <div class="flex flex-col gap-2">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">AraÃ§lar</label>
            
            <button onclick="setTool('ruler')" id="btn-ruler" class="tool-btn active flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl flex items-center justify-center text-blue-600" id="icon-ruler">ğŸ“</span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">Cetvel</div>
                    <div class="text-[10px] text-gray-400 font-medium">Uzunluk Ã¶lÃ§er</div>
                </div>
            </button>

            <button onclick="setTool('protractor')" id="btn-protractor" class="tool-btn flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl flex items-center justify-center text-orange-600" id="icon-protractor">ğŸ“</span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">AÃ§Ä±Ã¶lÃ§er</div>
                    <div class="text-[10px] text-gray-400 font-medium">Ä°Ã§ aÃ§Ä± Ã¶lÃ§er</div>
                </div>
            </button>

            <button onclick="setTool('compass')" id="btn-compass" class="tool-btn flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl flex items-center justify-center text-purple-600" id="icon-compass">ğŸ“</span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">Pergel</div>
                    <div class="text-[10px] text-gray-400 font-medium">Ã‡ember Ã§izer</div>
                </div>
            </button>
        </div>

        <!-- GÃ¶revler Butonu -->
        <div class="flex flex-col gap-2 mt-2">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1 flex items-center gap-1">
                <span>AlÄ±ÅŸtÄ±rmalar</span>
            </label>
            <button onclick="startTaskMode()" class="flex items-center gap-3 p-3 rounded-xl border border-green-100 bg-green-50 hover:bg-green-100 text-left w-full group transition-all shadow-sm">
                <span class="text-xl bg-white p-1.5 rounded-lg shadow-sm">ğŸ“</span>
                <div>
                    <div class="font-bold text-green-800 text-sm">GÃ¶rev BaÅŸlat</div>
                </div>
            </button>
        </div>

        <!-- Ayarlar -->
        <div class="flex flex-col gap-2 mt-2">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Renk & Izgara</label>
            <div class="flex gap-2 p-2 bg-gray-50 rounded-xl justify-center">
                <div onclick="setColor('#dc2626', this)" class="color-btn active bg-red-600" title="KÄ±rmÄ±zÄ±"></div>
                <div onclick="setColor('#1e40af', this)" class="color-btn bg-blue-800" title="Mavi"></div>
                <div onclick="setColor('#16a34a', this)" class="color-btn bg-green-600" title="YeÅŸil"></div>
                <div onclick="setColor('#d97706', this)" class="color-btn bg-amber-600" title="Turuncu"></div>
                <div onclick="setColor('#9333ea', this)" class="color-btn bg-purple-600" title="Mor"></div>
                <div onclick="setColor('#1f2937', this)" class="color-btn bg-gray-800" title="Siyah"></div>
            </div>
            <button onclick="toggleGrid()" class="flex items-center justify-between p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-gray-600 text-sm font-semibold">
                <span>Kareli Defter</span>
                <div class="w-8 h-4 bg-brand-500 rounded-full relative transition-colors" id="grid-toggle-bg">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-0.5 right-0.5 transition-all shadow-sm" id="grid-toggle-dot"></div>
                </div>
            </button>
        </div>

        <!-- Alt Butonlar -->
        <div class="mt-auto flex gap-2 pt-4 border-t border-gray-100">
            <button onclick="undoShape()" class="flex-1 py-3 px-4 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>â†©ï¸</span> Geri Al
            </button>
            <button onclick="openDeleteModal()" class="flex-1 py-3 px-4 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>ğŸ—‘ï¸</span> Sil
            </button>
        </div>
    </div>

    <!-- Canvas Area -->
    <div class="flex-1 relative h-full bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col">
        
        <!-- Ãœst Bilgi Ã‡ubuÄŸu (VarsayÄ±lan) -->
        <div id="default-info-bar" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm px-6 py-2 rounded-full shadow-sm border border-brand-100 pointer-events-none z-10 flex items-center gap-2 transition-all">
            <span id="current-tool-icon-top" class="text-xl">ğŸ“</span>
            <span id="instruction-text" class="text-sm font-semibold text-brand-800">BaÅŸlangÄ±Ã§ noktasÄ±na tÄ±kla ve sÃ¼rÃ¼kle</span>
        </div>

        <!-- GÃ–REV KUTUCUÄU -->
        <div id="task-card" class="absolute top-4 left-1/2 -translate-x-1/2 w-11/12 max-w-lg bg-white rounded-xl shadow-xl border-2 border-green-500 z-20 hidden-card p-0 overflow-hidden">
            <div class="bg-green-50 px-4 py-2 border-b border-green-100 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="bg-green-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full tracking-wider">GÃ–REV</span>
                    <span id="task-counter" class="text-green-800 font-bold text-sm">1 / 5</span>
                </div>
                <button onclick="endTaskMode()" class="text-gray-400 hover:text-red-500 text-sm font-bold px-2">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            <div class="p-5 text-center">
                <p id="task-question" class="text-lg font-bold text-gray-800 mb-4 leading-relaxed">
                    Soru yÃ¼kleniyor...
                </p>
                <div id="feedback-area" class="text-sm mb-4 h-6"></div>
                <div class="flex justify-center gap-3" id="task-buttons">
                    <button onclick="checkAnswer()" class="inline-flex items-center px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg transition-colors shadow-sm">
                        <span>Kontrol Et</span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                    <button onclick="nextTask()" id="btn-next-task" class="hidden inline-flex items-center px-6 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition-colors shadow-sm">
                        <span>SÄ±radaki Soru</span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="canvas-container" class="w-full h-full grid-bg relative transition-all duration-300">
            <canvas id="geometryCanvas" class="w-full h-full block"></canvas>
        </div>
    </div>

    <!-- JavaScript Uygulama MantÄ±ÄŸÄ± -->
    <script>
        // --- Soru BankasÄ± (Validasyonlu) ---
        // type: line (uzunluk cm), angle (derece), circle (yarÄ±Ã§ap cm)
        const questionBank = [
            { text: "Cetvel aracÄ±nÄ± kullanarak 5 cm uzunluÄŸunda bir doÄŸru parÃ§asÄ± Ã§iziniz.", check: {type: 'line', val: 5} },
            { text: "Cetvel aracÄ±nÄ± kullanarak 8.5 cm uzunluÄŸunda bir doÄŸru parÃ§asÄ± Ã§iziniz.", check: {type: 'line', val: 8.5} },
            { text: "Ekrana 3 cm uzunluÄŸunda bir doÄŸru parÃ§asÄ± Ã§iziniz.", check: {type: 'line', val: 3} },
            { text: "Cetvel yardÄ±mÄ±yla 7 cm uzunluÄŸunda bir doÄŸru parÃ§asÄ± Ã§iziniz.", check: {type: 'line', val: 7} },
            { text: "AÃ§Ä±Ã¶lÃ§er aracÄ±nÄ± kullanarak 90 derecelik bir dik aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 90} },
            { text: "AÃ§Ä±Ã¶lÃ§er ile 45 derecelik bir dar aÃ§Ä± oluÅŸturunuz.", check: {type: 'angle', val: 45} },
            { text: "AÃ§Ä±Ã¶lÃ§er kullanarak 120 derecelik bir geniÅŸ aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 120} },
            { text: "30 derecelik bir aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 30} },
            { text: "150 derecelik bir geniÅŸ aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 150} },
            { text: "180 derecelik bir doÄŸru aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 180} },
            { text: "60 derecelik bir aÃ§Ä± Ã§iziniz.", check: {type: 'angle', val: 60} },
            { text: "Pergel aracÄ±nÄ± seÃ§erek yarÄ±Ã§apÄ± 4 cm olan bir Ã§ember Ã§iziniz.", check: {type: 'circle', val: 4} },
            { text: "YarÄ±Ã§apÄ± 2.5 cm olan kÃ¼Ã§Ã¼k bir Ã§ember Ã§iziniz.", check: {type: 'circle', val: 2.5} },
            { text: "Ã‡apÄ± 10 cm olan (yani yarÄ±Ã§apÄ± 5 cm olan) bÃ¼yÃ¼k bir Ã§ember Ã§iziniz.", check: {type: 'circle', val: 5} },
            { text: "YarÄ±Ã§apÄ± 3 cm olan bir Ã§ember Ã§iziniz.", check: {type: 'circle', val: 3} }
        ];

        // --- DeÄŸiÅŸkenler ---
        let currentTasks = [];
        let taskIndex = 0;
        let isTaskMode = false;
        let solutionShape = null; // DoÄŸru cevabÄ± gÃ¶stermek iÃ§in

        // --- Ä°kon SVG'leri ---
        const svgIcons = {
            ruler: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>`,
            protractor: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19H2a10 10 0 0 1 20 0Z"/><path d="M12 19V14"/><path d="M12 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M2 19h20"/><path d="M18.3 12.7 17 14"/><path d="M5.7 12.7 7 14"/></svg>`,
            compass: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="m9.47 7.15-4 10.4"/><path d="m14.53 7.16 4 10.4"/><path d="M6.17 14h11.66"/></svg>`
        };

        // --- GiriÅŸ EkranÄ± ---
        function startSimulation() {
            const intro = document.getElementById('intro-screen');
            intro.classList.add('hidden-intro');
            setTimeout(() => { resizeCanvas(); }, 100);
        }

        // --- YapÄ±landÄ±rma ---
        const canvas = document.getElementById('geometryCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        
        let currentTool = 'ruler';
        let currentColor = '#dc2626';
        let isGridOn = true;
        let isDrawing = false;
        let protractorState = 0; 
        let startPoint = { x: 0, y: 0 }; 
        let currentPoint = { x: 0, y: 0 }; 
        let referencePoint = { x: 0, y: 0 }; 
        const PIXELS_PER_CM = 37.8;
        let shapes = [];

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        // --- GÃ¶rev Modu MantÄ±ÄŸÄ± ---
        function startTaskMode() {
            // Rastgele 5 soru seÃ§
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            currentTasks = shuffled.slice(0, 5);
            taskIndex = 0;
            isTaskMode = true;

            // EkranÄ± temizle
            performClearCanvas(); 
            shapes = [];
            protractorState = 0;
            draw();

            // UI DeÄŸiÅŸiklikleri
            document.getElementById('default-info-bar').style.opacity = '0';
            const taskCard = document.getElementById('task-card');
            taskCard.classList.remove('hidden-card');
            taskCard.classList.add('visible-card');

            showCurrentTask();
        }

        function showCurrentTask() {
            const task = currentTasks[taskIndex];
            document.getElementById('task-counter').innerText = `Soru ${taskIndex + 1} / 5`;
            document.getElementById('task-question').innerText = task.text;
            
            // Feedback alanÄ±nÄ± temizle
            const feedback = document.getElementById('feedback-area');
            feedback.innerHTML = "";
            solutionShape = null; // Ã‡Ã¶zÃ¼mÃ¼ sÄ±fÄ±rla
            
            // ButonlarÄ± ayarla
            document.getElementById('btn-next-task').classList.add('hidden');
            
            draw(); // Ã‡Ã¶zÃ¼m Ã§izimini temizlemek iÃ§in redraw
        }

        function checkAnswer() {
            const task = currentTasks[taskIndex];
            const feedback = document.getElementById('feedback-area');
            
            let isCorrect = false;
            let tolerance = 0;

            // Ekrandaki son ÅŸekli veya ilgili tÃ¼m ÅŸekilleri kontrol et
            // Basitlik iÃ§in son Ã§izilen veya herhangi bir uygun ÅŸekil var mÄ± diye bakalÄ±m
            if(shapes.length === 0) {
                feedback.innerHTML = "<span class='feedback-error'>LÃ¼tfen Ã¶nce bir Ã§izim yapÄ±n!</span>";
                return;
            }

            if (task.check.type === 'line') {
                tolerance = 0.5; // cm
                // Herhangi bir Ã§izgi istenen uzunlukta mÄ±?
                const found = shapes.find(s => {
                    if(s.type !== 'line') return false;
                    const len = Math.sqrt(Math.pow(s.end.x - s.start.x, 2) + Math.pow(s.end.y - s.start.y, 2)) / PIXELS_PER_CM;
                    return Math.abs(len - task.check.val) <= tolerance;
                });
                if(found) isCorrect = true;
            
            } else if (task.check.type === 'angle') {
                tolerance = 5; // derece
                const found = shapes.find(s => {
                    if(s.type !== 'angle-custom') return false;
                    // AÃ§Ä± hesabÄ±
                    const baseAngle = Math.atan2(s.refPoint.y - s.center.y, s.refPoint.x - s.center.x);
                    const currAngle = Math.atan2(s.endPoint.y - s.center.y, s.endPoint.x - s.center.x);
                    let diff = currAngle - baseAngle;
                    while (diff <= -Math.PI) diff += 2*Math.PI;
                    while (diff > Math.PI) diff -= 2*Math.PI;
                    const deg = Math.abs(diff * 180 / Math.PI);
                    return Math.abs(deg - task.check.val) <= tolerance;
                });
                if(found) isCorrect = true;

            } else if (task.check.type === 'circle') {
                tolerance = 0.3; // cm
                const found = shapes.find(s => {
                    if(s.type !== 'circle') return false;
                    const r = s.radius / PIXELS_PER_CM;
                    return Math.abs(r - task.check.val) <= tolerance;
                });
                if(found) isCorrect = true;
            }

            if (isCorrect) {
                feedback.innerHTML = "<span class='feedback-success'>ğŸ‰ Harika! DoÄŸru Ã§izdin.</span>";
                document.getElementById('btn-next-task').classList.remove('hidden');
            } else {
                feedback.innerHTML = `<span class='feedback-error'>HenÃ¼z tam olmadÄ±. DoÄŸrusu (${task.check.val}) yeÅŸil renkte gÃ¶steriliyor.</span>`;
                showSolution(task); // DoÄŸru cevabÄ± gÃ¶ster
                document.getElementById('btn-next-task').classList.remove('hidden'); // YanlÄ±ÅŸsa da geÃ§ebilsin
            }
        }

        function showSolution(task) {
            // DoÄŸru cevabÄ± temsil eden bir "hayalet" ÅŸekil oluÅŸtur
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            if (task.check.type === 'line') {
                const lenPx = task.check.val * PIXELS_PER_CM;
                solutionShape = {
                    type: 'line',
                    start: {x: centerX - lenPx/2, y: centerY},
                    end: {x: centerX + lenPx/2, y: centerY},
                    color: '#22c55e', // YeÅŸil
                    isSolution: true
                };
            } else if (task.check.type === 'angle') {
                const rad = task.check.val * Math.PI / 180;
                const len = 100;
                solutionShape = {
                    type: 'angle-custom',
                    center: {x: centerX, y: centerY},
                    refPoint: {x: centerX + len, y: centerY},
                    endPoint: {x: centerX + Math.cos(-rad)*len, y: centerY + Math.sin(-rad)*len}, // Canvas Y ters
                    color: '#22c55e',
                    isSolution: true
                };
            } else if (task.check.type === 'circle') {
                const rPx = task.check.val * PIXELS_PER_CM;
                solutionShape = {
                    type: 'circle',
                    center: {x: centerX, y: centerY},
                    radius: rPx,
                    color: '#22c55e',
                    isSolution: true,
                    isAnimating: false
                };
            }
            draw();
        }

        function nextTask() {
            shapes = [];
            solutionShape = null; // Ã‡Ã¶zÃ¼mÃ¼ temizle
            protractorState = 0;
            draw();

            taskIndex++;
            if (taskIndex >= currentTasks.length) {
                alert("Tebrikler! TÃ¼m gÃ¶revleri tamamladÄ±n.");
                endTaskMode();
            } else {
                showCurrentTask();
            }
        }

        function endTaskMode() {
            isTaskMode = false;
            document.getElementById('default-info-bar').style.opacity = '1';
            const taskCard = document.getElementById('task-card');
            taskCard.classList.remove('visible-card');
            taskCard.classList.add('hidden-card');
            shapes = [];
            solutionShape = null;
            draw();
            setTool('ruler');
        }

        // --- AraÃ§ SeÃ§imi & UI ---
        function setTool(tool) {
            currentTool = tool;
            protractorState = 0; 
            isDrawing = false;
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');
            
            const iconHTML = svgIcons[tool];
            document.getElementById('icon-' + tool).innerHTML = iconHTML; 
            document.getElementById('current-tool-icon-top').innerHTML = iconHTML; 
            
            updateInstruction();
            draw();
        }

        setTool('ruler'); // BaÅŸlangÄ±Ã§

        function updateInstruction() {
            if(isTaskMode) return;
            const el = document.getElementById('instruction-text');
            if (currentTool === 'ruler') el.innerText = 'Ã‡izgi Ã§izmek iÃ§in tÄ±kla ve sÃ¼rÃ¼kle';
            else if (currentTool === 'compass') el.innerText = 'Merkezi seÃ§ ve yarÄ±Ã§apÄ± aÃ§';
            else if (currentTool === 'protractor') {
                if (protractorState === 0) el.innerText = '1. AdÄ±m: BaÅŸlangÄ±Ã§ kolunu Ã§izmek iÃ§in sÃ¼rÃ¼kle';
                else if (protractorState === 1) el.innerText = 'BÄ±rakÄ±nca baÅŸlangÄ±Ã§ kolu oluÅŸacak';
                else if (protractorState === 2) el.innerText = '2. AdÄ±m: AÃ§Ä±yÄ± belirlemek iÃ§in fareyi hareket ettir ve tÄ±kla';
            }
        }

        function setColor(color, element) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        function toggleGrid() {
            isGridOn = !isGridOn;
            const bg = document.getElementById('grid-toggle-bg');
            const dot = document.getElementById('grid-toggle-dot');
            const container = document.getElementById('canvas-container');

            if(isGridOn) {
                container.classList.remove('grid-bg-none');
                container.classList.add('grid-bg');
                bg.className = "w-8 h-4 bg-brand-500 rounded-full relative transition-colors";
                dot.className = "w-3 h-3 bg-white rounded-full absolute top-0.5 right-0.5 transition-all shadow-sm";
            } else {
                container.classList.remove('grid-bg');
                container.classList.add('grid-bg-none');
                bg.className = "w-8 h-4 bg-gray-300 rounded-full relative transition-colors";
                dot.className = "w-3 h-3 bg-white rounded-full absolute top-0.5 left-0.5 transition-all shadow-sm";
            }
        }

        function undoShape() {
            if(shapes.length > 0) {
                shapes.pop();
                draw();
            }
        }

        function openDeleteModal() {
            const modal = document.getElementById('delete-modal');
            const content = document.getElementById('delete-modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            });
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            const content = document.getElementById('delete-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 200);
        }

        function performClearCanvas() {
            shapes = [];
            protractorState = 0;
            updateInstruction();
            draw();
            closeDeleteModal();
        }

        // --- Fare OlaylarÄ± ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }
        function getTouchPos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top };
        }

        function startAction(pos) {
            if (currentTool === 'protractor' && protractorState === 2) {
                const baseAngle = Math.atan2(referencePoint.y - startPoint.y, referencePoint.x - startPoint.x);
                shapes.push({ 
                    type: 'angle-custom', 
                    center: startPoint, 
                    refPoint: referencePoint,
                    endPoint: pos,
                    color: currentColor 
                });
                protractorState = 0;
                updateInstruction();
                draw();
                return;
            }
            isDrawing = true;
            startPoint = pos;
            currentPoint = pos;
            if (currentTool === 'protractor') {
                protractorState = 1; 
                updateInstruction();
            }
            draw();
        }

        function moveAction(pos) {
            currentPoint = pos;
            if (currentTool === 'protractor' && protractorState === 2) {
                draw();
                return;
            }
            if (!isDrawing) return;
            draw();
        }

        function endAction() {
            if (!isDrawing) return;
            isDrawing = false;
            
            const dist = Math.sqrt(Math.pow(currentPoint.x - startPoint.x, 2) + Math.pow(currentPoint.y - startPoint.y, 2));
            if(dist < 5) {
                if(currentTool === 'protractor') protractorState = 0;
                draw();
                return; 
            }

            if (currentTool === 'ruler') {
                shapes.push({ type: 'line', start: startPoint, end: currentPoint, color: currentColor });
            } else if (currentTool === 'compass') {
                const newShape = { 
                    type: 'circle', 
                    center: startPoint, 
                    radius: dist, 
                    color: currentColor, 
                    animationAngle: 0, 
                    isAnimating: true 
                };
                shapes.push(newShape);
                animateCircle(newShape);
            } else if (currentTool === 'protractor') {
                if (protractorState === 1) {
                    referencePoint = { ...currentPoint };
                    protractorState = 2; 
                    updateInstruction();
                }
            }
            draw();
        }

        // Event Listeners
        canvas.addEventListener('mousedown', (e) => startAction(getMousePos(e)));
        canvas.addEventListener('mousemove', (e) => moveAction(getMousePos(e)));
        window.addEventListener('mouseup', endAction);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startAction(getTouchPos(e)); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveAction(getTouchPos(e)); }, {passive: false});
        window.addEventListener('touchend', endAction);

        // --- Ã‡izim ve Animasyon ---
        function animateCircle(shape) {
            function step() {
                if (!shape.isAnimating) return;
                shape.animationAngle += 0.04; 
                if (shape.animationAngle >= 2 * Math.PI) {
                    shape.animationAngle = 2 * Math.PI;
                    shape.isAnimating = false;
                }
                draw();
                if (shape.isAnimating) {
                    requestAnimationFrame(step);
                }
            }
            requestAnimationFrame(step);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Mevcut Åekiller
            shapes.forEach(shape => {
                ctx.strokeStyle = shape.color;
                if (shape.type === 'line') {
                    ctx.beginPath(); ctx.moveTo(shape.start.x, shape.start.y); ctx.lineTo(shape.end.x, shape.end.y);
                    ctx.lineWidth = 3; ctx.stroke(); drawDot(shape.start, shape.color); drawDot(shape.end, shape.color);
                } else if (shape.type === 'circle') {
                    let endAngle = shape.isAnimating ? shape.animationAngle : 2 * Math.PI;
                    ctx.beginPath(); ctx.arc(shape.center.x, shape.center.y, shape.radius, 0, endAngle);
                    ctx.lineWidth = 2; ctx.stroke(); drawDot(shape.center, shape.color);
                    if (shape.isAnimating) {
                        const tx = shape.center.x + Math.cos(endAngle) * shape.radius;
                        const ty = shape.center.y + Math.sin(endAngle) * shape.radius;
                        drawCompassTool(shape.center, {x: tx, y: ty}, shape.color);
                    }
                } else if (shape.type === 'angle-custom') {
                    drawAngleShape(shape.center, shape.refPoint, shape.endPoint, shape.color, false);
                }
            });

            // Ã‡Ã¶zÃ¼m Åekli (Varsa)
            if (solutionShape) {
                ctx.save();
                ctx.strokeStyle = solutionShape.color;
                ctx.setLineDash([10, 10]); // Kesikli Ã§izgi
                ctx.lineWidth = 4;
                ctx.globalAlpha = 0.7; // Biraz saydam

                if (solutionShape.type === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(solutionShape.start.x, solutionShape.start.y);
                    ctx.lineTo(solutionShape.end.x, solutionShape.end.y);
                    ctx.stroke();
                    drawLabel("OlmasÄ± Gereken", solutionShape.start.x, solutionShape.start.y - 30, '#16a34a');
                } else if (solutionShape.type === 'angle-custom') {
                    drawAngleShape(solutionShape.center, solutionShape.refPoint, solutionShape.endPoint, solutionShape.color, false);
                    drawLabel("OlmasÄ± Gereken", solutionShape.endPoint.x, solutionShape.endPoint.y - 30, '#16a34a');
                } else if (solutionShape.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(solutionShape.center.x, solutionShape.center.y, solutionShape.radius, 0, 2*Math.PI);
                    ctx.stroke();
                    drawLabel("OlmasÄ± Gereken", solutionShape.center.x + solutionShape.radius, solutionShape.center.y, '#16a34a');
                }
                ctx.restore();
            }

            if (currentTool === 'ruler' && isDrawing) drawActiveRuler();
            else if (currentTool === 'compass' && isDrawing) drawActiveCompass();
            else if (currentTool === 'protractor') {
                if (protractorState === 1 && isDrawing) drawReferenceLinePreview();
                else if (protractorState === 2) drawAngleMeasurementPreview();
            }
        }

        // --- Helper Ã‡izim FonksiyonlarÄ± ---
        function drawDot(pos, color) {
            ctx.beginPath(); ctx.arc(pos.x, pos.y, 4, 0, 2 * Math.PI); ctx.fillStyle = color; ctx.fill();
            ctx.beginPath(); ctx.arc(pos.x, pos.y, 1.5, 0, 2 * Math.PI); ctx.fillStyle = '#fff'; ctx.fill();
        }

        function drawLabel(text, x, y, color = '#374151') {
            ctx.save();
            ctx.font = "600 14px Montserrat, sans-serif";
            const metrics = ctx.measureText(text);
            const p = 6; 
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 4;
            ctx.beginPath();
            ctx.roundRect(x + 10, y + 10, metrics.width + p*2, 24, 6);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = color;
            ctx.textBaseline = 'top';
            ctx.fillText(text, x + 10 + p, y + 10 + 5);
            ctx.restore();
        }

        function drawCompassTool(center, tip, color) {
            const midX = (center.x + tip.x) / 2;
            const midY = (center.y + tip.y) / 2;
            const topY = midY - 120; 
            ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(midX, topY); ctx.lineTo(tip.x, tip.y); 
            ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#7e22ce'; ctx.lineWidth = 6; ctx.stroke();
            ctx.beginPath(); ctx.arc(midX, topY, 8, 0, Math.PI*2); ctx.fillStyle = '#581c87'; ctx.fill();
            ctx.beginPath(); ctx.arc(tip.x, tip.y, 2, 0, Math.PI*2); ctx.fillStyle = color; ctx.fill();
        }

        function drawAngleShape(center, refPt, endPt, color, isPreview) {
            ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(refPt.x, refPt.y); ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(endPt.x, endPt.y); ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            const baseAngle = Math.atan2(refPt.y - center.y, refPt.x - center.x);
            const currentAngle = Math.atan2(endPt.y - center.y, endPt.x - center.x);
            let diff = currentAngle - baseAngle;
            while (diff <= -Math.PI) diff += 2*Math.PI; while (diff > Math.PI) diff -= 2*Math.PI;
            ctx.beginPath(); ctx.arc(center.x, center.y, 30, baseAngle, baseAngle + diff, diff < 0); ctx.strokeStyle = color; ctx.stroke();
            drawDot(center, color);
            let degrees = Math.abs(diff * 180 / Math.PI);
            let midAngle = baseAngle + (diff / 2);
            let labelDist = 60;
            let lx = center.x + Math.cos(midAngle) * labelDist - 25;
            let ly = center.y + Math.sin(midAngle) * labelDist - 25;
            drawLabel(`${Math.round(degrees)}Â°`, lx, ly, color);
        }

        function drawReferenceLinePreview() {
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(currentPoint.x, currentPoint.y); ctx.strokeStyle = currentColor; ctx.lineWidth = 3; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
            drawDot(startPoint, currentColor); drawLabel("BaÅŸlangÄ±Ã§ Kolu", currentPoint.x, currentPoint.y, currentColor);
        }

        function drawAngleMeasurementPreview() {
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(referencePoint.x, referencePoint.y); ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 3; ctx.stroke();
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(currentPoint.x, currentPoint.y); ctx.strokeStyle = currentColor; ctx.lineWidth = 3; ctx.stroke();
            const baseAngle = Math.atan2(referencePoint.y - startPoint.y, referencePoint.x - startPoint.x);
            ctx.save(); ctx.translate(startPoint.x, startPoint.y); ctx.rotate(baseAngle); 
            const r = 130;
            ctx.beginPath(); ctx.arc(0, 0, r, 0, 2*Math.PI); ctx.fillStyle = 'rgba(255, 237, 213, 0.5)'; ctx.fill(); ctx.strokeStyle = '#ea580c'; ctx.lineWidth = 1; ctx.stroke();
            ctx.font = '10px Montserrat, sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#7c2d12';
            for(let i=0; i<360; i+=10) {
                let rad = (i * Math.PI) / 180; let outer = r; let inner = (i%30===0) ? r-15 : r-5;
                ctx.beginPath(); ctx.moveTo(Math.cos(rad)*outer, Math.sin(rad)*outer); ctx.lineTo(Math.cos(rad)*inner, Math.sin(rad)*inner); ctx.stroke();
                if(i%30===0) { let tx = Math.cos(rad) * (r-25); let ty = Math.sin(rad) * (r-25); ctx.fillText(i, tx, ty); }
            }
            const mouseAngleGlobal = Math.atan2(currentPoint.y - startPoint.y, currentPoint.x - startPoint.x);
            let relativeAngle = mouseAngleGlobal - baseAngle;
            while (relativeAngle <= -Math.PI) relativeAngle += 2*Math.PI; while (relativeAngle > Math.PI) relativeAngle -= 2*Math.PI;
            ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0, 0, r, 0, relativeAngle, relativeAngle < 0); ctx.lineTo(0,0); ctx.fillStyle = 'rgba(234, 88, 12, 0.3)'; ctx.fill();
            ctx.restore();
            let degrees = Math.abs(relativeAngle * (180/Math.PI));
            let midRelAngle = relativeAngle / 2;
            let globalMidAngle = baseAngle + midRelAngle;
            let labelR = r + 40;
            let lx = startPoint.x + Math.cos(globalMidAngle) * labelR - 25;
            let ly = startPoint.y + Math.sin(globalMidAngle) * labelR - 25;
            drawLabel(`${Math.round(degrees)}Â°`, lx, ly, currentColor);
            drawDot(startPoint, currentColor);
        }

        function drawActiveRuler() {
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(currentPoint.x, currentPoint.y); ctx.strokeStyle = currentColor; ctx.lineWidth = 3; ctx.stroke();
            const dx = currentPoint.x - startPoint.x; const dy = currentPoint.y - startPoint.y; const pixelDist = Math.sqrt(dx*dx + dy*dy); const cm = (pixelDist / PIXELS_PER_CM).toFixed(1);
            drawLabel(`${cm} cm`, currentPoint.x, currentPoint.y, currentColor);
            ctx.save(); ctx.translate(startPoint.x, startPoint.y); ctx.rotate(Math.atan2(dy, dx));
            ctx.fillStyle = 'rgba(250, 204, 21, 0.4)'; ctx.fillRect(0, 10, pixelDist + 40, 40);
            ctx.beginPath(); ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 1; ctx.font = '500 10px Montserrat, sans-serif'; ctx.fillStyle = '#000'; ctx.textAlign = 'center';
            const totalCm = Math.ceil(pixelDist / PIXELS_PER_CM);
            for(let i=0; i<= totalCm+1; i++) {
                let x = i * PIXELS_PER_CM; if(x > pixelDist + 30) break;
                ctx.moveTo(x, 10); ctx.lineTo(x, 25); ctx.fillText(i, x, 38);
                for(let j=1; j<10; j++) { let mx = x + (j * PIXELS_PER_CM/10); if(mx > pixelDist + 30) break; ctx.moveTo(mx, 10); ctx.lineTo(mx, j==5? 20 : 15); }
            }
            ctx.stroke(); ctx.restore();
        }

        function drawActiveCompass() {
            const dx = currentPoint.x - startPoint.x; const dy = currentPoint.y - startPoint.y; const radius = Math.sqrt(dx*dx + dy*dy); const cm = (radius / PIXELS_PER_CM).toFixed(1);
            ctx.beginPath(); ctx.arc(startPoint.x, startPoint.y, radius, 0, Math.PI*2); ctx.strokeStyle = currentColor; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
            ctx.beginPath(); ctx.moveTo(startPoint.x, startPoint.y); ctx.lineTo(currentPoint.x, currentPoint.y); ctx.strokeStyle = '#d8b4fe'; ctx.stroke();
            drawLabel(`r: ${cm} cm`, currentPoint.x, currentPoint.y, currentColor);
            drawCompassTool(startPoint, currentPoint, currentColor);
        }
    </script>
</body>
</html>