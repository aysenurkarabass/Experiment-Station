<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5. Sƒ±nƒ±f Matematik √áizim At√∂lyesi</title>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626', // Ana Logo Rengi (Kƒ±rmƒ±zƒ±)
                            700: '#b91c1c',
                            800: '#991b1b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }

        #canvas-container {
            cursor: crosshair;
            background-color: #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .tool-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .tool-btn:active { transform: scale(0.95); }
        
        .tool-btn.active {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #b91c1c;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1);
        }
        .tool-btn.active::after {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background-color: #dc2626;
        }

        .color-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #d1d5db;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active {
            box-shadow: 0 0 0 2px #dc2626, 0 0 0 4px white;
            transform: scale(1.1);
        }

        .grid-bg {
            background-size: 20px 20px;
            background-image: 
                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
        }
        .grid-bg-none { background-image: none; }

        /* Giri≈ü Ekranƒ± Animasyonu */
        #intro-screen {
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #intro-screen.hidden-intro {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row p-2 md:p-4 gap-4 relative">

    <!-- Giri≈ü Ekranƒ± (Intro Screen) -->
    <div id="intro-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="max-w-2xl w-full bg-white">
            <!-- Logo -->
            <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" alt="e12 Logosu" class="h-20 mx-auto mb-8 object-contain">
            
            <h1 class="text-3xl md:text-4xl font-bold text-brand-700 mb-4">Matematik √áizim At√∂lyesi</h1>
            <p class="text-gray-600 mb-8 text-lg">Temel geometrik √ßizim ara√ßlarƒ±nƒ± ke≈üfetmeye hazƒ±r mƒ±sƒ±n?</p>

            <!-- Y√∂nergeler -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-left">
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 flex flex-col items-center text-center group hover:shadow-md transition-shadow">
                    <!-- Ruler Icon -->
                    <div class="mb-3 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/>
                            <path d="m14.5 12.5 2-2"/>
                            <path d="m11.5 9.5 2-2"/>
                            <path d="m8.5 6.5 2-2"/>
                            <path d="m17.5 15.5 2-2"/>
                        </svg>
                    </div>
                    <h3 class="font-bold text-blue-800 mb-1">Cetvel</h3>
                    <p class="text-sm text-blue-600">Doƒüru par√ßalarƒ± √ßiz ve uzunluklarƒ±nƒ± √∂l√ß.</p>
                </div>
                <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 flex flex-col items-center text-center group hover:shadow-md transition-shadow">
                    <!-- Protractor Icon -->
                    <div class="mb-3 text-orange-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 19H2a10 10 0 0 1 20 0Z" />
                            <path d="M12 19V14" />
                            <path d="M12 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" />
                            <path d="M2 19h20" />
                            <path d="M18.3 12.7 17 14" />
                            <path d="M5.7 12.7 7 14" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-orange-800 mb-1">A√ßƒ±√∂l√ßer</h3>
                    <p class="text-sm text-orange-600">A√ßƒ±larƒ± olu≈ütur, √∂l√ß ve √ße≈üitlerini tanƒ±.</p>
                </div>
                <div class="bg-purple-50 p-5 rounded-xl border border-purple-100 flex flex-col items-center text-center group hover:shadow-md transition-shadow">
                    <!-- Compass Icon -->
                    <div class="mb-3 text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="5" r="2"/>
                            <path d="m9.47 7.15-4 10.4"/>
                            <path d="m14.53 7.16 4 10.4"/>
                            <path d="M6.17 14h11.66"/>
                        </svg>
                    </div>
                    <h3 class="font-bold text-purple-800 mb-1">Pergel</h3>
                    <p class="text-sm text-purple-600">Merkezi belirle ve √ßemberler √ßiz.</p>
                </div>
            </div>

            <!-- Ba≈ülat Butonu -->
            <button onclick="startSimulation()" class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-brand-600 font-lg rounded-full hover:bg-brand-700 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-brand-500">
                At√∂lyeye Gir
                <div class="absolute inset-0 rounded-full ring-2 ring-white/20 group-hover:ring-white/40"></div>
            </button>
        </div>
        
        <!-- Footer Info -->
        <div class="absolute bottom-6 text-xs text-gray-400">
            5. Sƒ±nƒ±f Matematik &bull; Geometrik √áizimlerde Ara√ß ve Teknoloji
        </div>
    </div>

    <!-- Sidebar (Tools) -->
    <div class="flex flex-col gap-4 w-full md:w-64 bg-white rounded-2xl shadow-lg p-4 h-auto md:h-full overflow-y-auto z-10">
        
        <!-- Header with Logo -->
        <div class="text-center pb-4 border-b border-gray-100 flex flex-col items-center">
            <img src="https://ogrenci.e12.com.tr/logo/tr/logo.svg" alt="e12 Logosu" class="h-12 mb-2 object-contain">
            <h1 class="text-lg font-bold text-brand-800">√áizim At√∂lyesi</h1>
            <p class="text-xs text-gray-500 font-medium">Ara√ßlarƒ±nƒ± se√ß ve tasarla!</p>
        </div>

        <!-- Main Tools -->
        <div class="flex flex-col gap-2">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Ara√ßlar</label>
            
            <button onclick="setTool('ruler')" id="btn-ruler" class="tool-btn active flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl bg-blue-100 p-2 rounded-lg group-hover:scale-110 transition-transform flex items-center justify-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>
                </span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">Cetvel</div>
                    <div class="text-[10px] text-gray-400 font-medium">Uzunluk √∂l√ßer</div>
                </div>
            </button>

            <button onclick="setTool('protractor')" id="btn-protractor" class="tool-btn flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl bg-orange-100 p-2 rounded-lg group-hover:scale-110 transition-transform flex items-center justify-center text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19H2a10 10 0 0 1 20 0Z"/><path d="M12 19V14"/><path d="M12 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M2 19h20"/><path d="M18.3 12.7 17 14"/><path d="M5.7 12.7 7 14"/></svg>
                </span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">A√ßƒ±√∂l√ßer</div>
                    <div class="text-[10px] text-gray-400 font-medium">ƒ∞√ß a√ßƒ± √∂l√ßer</div>
                </div>
            </button>

            <button onclick="setTool('compass')" id="btn-compass" class="tool-btn flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-left w-full group">
                <span class="text-2xl bg-purple-100 p-2 rounded-lg group-hover:scale-110 transition-transform flex items-center justify-center text-purple-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="m9.47 7.15-4 10.4"/><path d="m14.53 7.16 4 10.4"/><path d="M6.17 14h11.66"/></svg>
                </span>
                <div>
                    <div class="font-bold text-gray-700 text-sm">Pergel</div>
                    <div class="text-[10px] text-gray-400 font-medium">√áember √ßizer</div>
                </div>
            </button>
        </div>

        <!-- Settings -->
        <div class="flex flex-col gap-2 mt-2">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Ayarlar</label>
            
            <!-- Colors -->
            <div class="flex gap-2 p-2 bg-gray-50 rounded-xl justify-center">
                <div onclick="setColor('#dc2626', this)" class="color-btn active bg-red-600" title="Kƒ±rmƒ±zƒ±"></div>
                <div onclick="setColor('#1e40af', this)" class="color-btn bg-blue-800" title="Mavi"></div>
                <div onclick="setColor('#16a34a', this)" class="color-btn bg-green-600" title="Ye≈üil"></div>
                <div onclick="setColor('#d97706', this)" class="color-btn bg-amber-600" title="Turuncu"></div>
                <div onclick="setColor('#9333ea', this)" class="color-btn bg-purple-600" title="Mor"></div>
                <div onclick="setColor('#1f2937', this)" class="color-btn bg-gray-800" title="Siyah"></div>
            </div>

            <!-- Toggle Grid -->
            <button onclick="toggleGrid()" class="flex items-center justify-between p-3 rounded-xl border border-gray-100 hover:bg-gray-50 text-gray-600 text-sm font-semibold">
                <span>Kareli Defter</span>
                <div class="w-8 h-4 bg-brand-500 rounded-full relative transition-colors" id="grid-toggle-bg">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-0.5 right-0.5 transition-all shadow-sm" id="grid-toggle-dot"></div>
                </div>
            </button>
        </div>

        <!-- Actions -->
        <div class="mt-auto flex gap-2 pt-4 border-t border-gray-100">
            <button onclick="undoShape()" class="flex-1 py-3 px-4 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>‚Ü©Ô∏è</span> Geri Al
            </button>
            <button onclick="clearCanvas()" class="flex-1 py-3 px-4 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>üóëÔ∏è</span> Sil
            </button>
        </div>
    </div>

    <!-- Canvas Area -->
    <div class="flex-1 relative h-full bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col">
        
        <!-- Top Info Bar -->
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm px-6 py-2 rounded-full shadow-sm border border-brand-100 pointer-events-none z-10 flex items-center gap-2">
            <span id="current-tool-icon" class="text-xl flex items-center"></span>
            <span id="instruction-text" class="text-sm font-semibold text-brand-800">Ba≈ülangƒ±√ß noktasƒ±na tƒ±kla ve s√ºr√ºkle</span>
        </div>

        <div id="canvas-container" class="w-full h-full grid-bg relative transition-all duration-300">
            <canvas id="geometryCanvas" class="w-full h-full block"></canvas>
        </div>
    </div>

    <!-- JavaScript Uygulama Mantƒ±ƒüƒ± -->
    <script>
        // --- ƒ∞kon Tanƒ±mlarƒ± (SVG Strings) ---
        const svgIcons = {
            ruler: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>`,
            protractor: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-600"><path d="M22 19H2a10 10 0 0 1 20 0Z"/><path d="M12 19V14"/><path d="M12 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M2 19h20"/><path d="M18.3 12.7 17 14"/><path d="M5.7 12.7 7 14"/></svg>`,
            compass: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><circle cx="12" cy="5" r="2"/><path d="m9.47 7.15-4 10.4"/><path d="m14.53 7.16 4 10.4"/><path d="M6.17 14h11.66"/></svg>`
        };

        // --- Giri≈ü Ekranƒ± Kontrol√º ---
        function startSimulation() {
            const intro = document.getElementById('intro-screen');
            intro.classList.add('hidden-intro');
            
            // Canvas boyutunu animasyon bittikten sonra tekrar g√ºncelle ki d√ºzg√ºn g√∂r√ºns√ºn
            setTimeout(() => {
                resizeCanvas();
            }, 100);
        }

        // --- Yapƒ±landƒ±rma ---
        const canvas = document.getElementById('geometryCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        
        let currentTool = 'ruler';
        let currentColor = '#dc2626';
        let isGridOn = true;
        let isDrawing = false;
        
        let protractorState = 0; 
        
        let startPoint = { x: 0, y: 0 }; 
        let currentPoint = { x: 0, y: 0 }; 
        let referencePoint = { x: 0, y: 0 }; 
        
        const PIXELS_PER_CM = 37.8;
        let shapes = [];

        // --- Boyutlandƒ±rma ---
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        // ƒ∞lk y√ºklemede √ßalƒ±≈ütƒ±r
        setTimeout(resizeCanvas, 100);

        // --- Ara√ß Se√ßimi & UI ---
        function setTool(tool) {
            currentTool = tool;
            protractorState = 0; 
            isDrawing = false;
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${tool}`).classList.add('active');
            
            // ƒ∞konlarƒ± SVG olarak g√ºncelle
            document.getElementById('current-tool-icon').innerHTML = svgIcons[tool];
            
            updateInstruction();
            draw();
        }

        // Ba≈ülangƒ±√ßta ikonun y√ºklenmesi i√ßin
        setTool('ruler');

        function updateInstruction() {
            const el = document.getElementById('instruction-text');
            if (currentTool === 'ruler') {
                el.innerText = '√áizgi √ßizmek i√ßin tƒ±kla ve s√ºr√ºkle';
            } else if (currentTool === 'compass') {
                el.innerText = 'Merkezi se√ß ve yarƒ±√ßapƒ± a√ß';
            } else if (currentTool === 'protractor') {
                if (protractorState === 0) el.innerText = '1. Adƒ±m: Ba≈ülangƒ±√ß kolunu √ßizmek i√ßin s√ºr√ºkle';
                else if (protractorState === 1) el.innerText = 'Bƒ±rakƒ±nca ba≈ülangƒ±√ß kolu olu≈üacak';
                else if (protractorState === 2) el.innerText = '2. Adƒ±m: A√ßƒ±yƒ± belirlemek i√ßin fareyi hareket ettir ve tƒ±kla';
            }
        }

        function setColor(color, element) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        function toggleGrid() {
            isGridOn = !isGridOn;
            const bg = document.getElementById('grid-toggle-bg');
            const dot = document.getElementById('grid-toggle-dot');
            const container = document.getElementById('canvas-container');

            if(isGridOn) {
                container.classList.remove('grid-bg-none');
                container.classList.add('grid-bg');
                bg.className = "w-8 h-4 bg-brand-500 rounded-full relative transition-colors";
                dot.className = "w-3 h-3 bg-white rounded-full absolute top-0.5 right-0.5 transition-all shadow-sm";
            } else {
                container.classList.remove('grid-bg');
                container.classList.add('grid-bg-none');
                bg.className = "w-8 h-4 bg-gray-300 rounded-full relative transition-colors";
                dot.className = "w-3 h-3 bg-white rounded-full absolute top-0.5 left-0.5 transition-all shadow-sm";
            }
        }

        function undoShape() {
            if(shapes.length > 0) {
                shapes.pop();
                draw();
            }
        }

        function clearCanvas() {
            if(confirm("T√ºm sayfa temizlenecek. Emin misin?")) {
                shapes = [];
                protractorState = 0;
                updateInstruction();
                draw();
            }
        }

        // --- Fare Olaylarƒ± ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }
        function getTouchPos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top };
        }

        function startAction(pos) {
            if (currentTool === 'protractor' && protractorState === 2) {
                const baseAngle = Math.atan2(referencePoint.y - startPoint.y, referencePoint.x - startPoint.x);
                shapes.push({ 
                    type: 'angle-custom', 
                    center: startPoint, 
                    refPoint: referencePoint,
                    endPoint: pos,
                    color: currentColor 
                });
                
                protractorState = 0;
                updateInstruction();
                draw();
                return;
            }

            isDrawing = true;
            startPoint = pos;
            currentPoint = pos;

            if (currentTool === 'protractor') {
                protractorState = 1; 
                updateInstruction();
            }
            draw();
        }

        function moveAction(pos) {
            currentPoint = pos;
            if (currentTool === 'protractor' && protractorState === 2) {
                draw();
                return;
            }
            if (!isDrawing) return;
            draw();
        }

        function endAction() {
            if (!isDrawing) return;
            isDrawing = false;
            
            const dist = Math.sqrt(Math.pow(currentPoint.x - startPoint.x, 2) + Math.pow(currentPoint.y - startPoint.y, 2));
            if(dist < 5) {
                if(currentTool === 'protractor') protractorState = 0;
                draw();
                return; 
            }

            if (currentTool === 'ruler') {
                shapes.push({ type: 'line', start: startPoint, end: currentPoint, color: currentColor });
            } else if (currentTool === 'compass') {
                shapes.push({ type: 'circle', center: startPoint, radius: dist, color: currentColor });
            } else if (currentTool === 'protractor') {
                if (protractorState === 1) {
                    referencePoint = { ...currentPoint };
                    protractorState = 2; 
                    updateInstruction();
                }
            }
            draw();
        }

        // Event Listeners
        canvas.addEventListener('mousedown', (e) => startAction(getMousePos(e)));
        canvas.addEventListener('mousemove', (e) => moveAction(getMousePos(e)));
        window.addEventListener('mouseup', endAction);
        
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startAction(getTouchPos(e)); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveAction(getTouchPos(e)); }, {passive: false});
        window.addEventListener('touchend', endAction);

        // --- √áizim Motoru ---

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            shapes.forEach(shape => {
                ctx.strokeStyle = shape.color;
                
                if (shape.type === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(shape.start.x, shape.start.y);
                    ctx.lineTo(shape.end.x, shape.end.y);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    drawDot(shape.start, shape.color);
                    drawDot(shape.end, shape.color);

                } else if (shape.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(shape.center.x, shape.center.y, shape.radius, 0, 2 * Math.PI);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    drawDot(shape.center, shape.color);
                
                } else if (shape.type === 'angle-custom') {
                    drawAngleShape(shape.center, shape.refPoint, shape.endPoint, shape.color, false);
                }
            });

            if (currentTool === 'ruler' && isDrawing) {
                drawActiveRuler();
            } else if (currentTool === 'compass' && isDrawing) {
                drawActiveCompass();
            } else if (currentTool === 'protractor') {
                if (protractorState === 1 && isDrawing) {
                    drawReferenceLinePreview();
                } else if (protractorState === 2) {
                    drawAngleMeasurementPreview();
                }
            }
        }

        // --- Yardƒ±mcƒ± √áizim Fonksiyonlarƒ± ---

        function drawDot(pos, color) {
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 4, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.beginPath(); 
            ctx.arc(pos.x, pos.y, 1.5, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        function drawLabel(text, x, y, color = '#374151') {
            ctx.save();
            ctx.font = "600 14px Montserrat";
            const metrics = ctx.measureText(text);
            const p = 6; 
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 4;
            ctx.beginPath();
            ctx.roundRect(x + 10, y + 10, metrics.width + p*2, 24, 6);
            ctx.fill();
            
            ctx.shadowBlur = 0;
            ctx.fillStyle = color;
            ctx.textBaseline = 'top';
            ctx.fillText(text, x + 10 + p, y + 10 + 5);
            ctx.restore();
        }

        // --- Yeni A√ßƒ± Mantƒ±ƒüƒ± √áizimi (En Kƒ±sa Yol) ---
        
        function drawAngleShape(center, refPt, endPt, color, isPreview) {
            // Referans Kolu
            ctx.beginPath();
            ctx.moveTo(center.x, center.y);
            ctx.lineTo(refPt.x, refPt.y);
            ctx.strokeStyle = color; 
            ctx.lineWidth = 3;
            ctx.stroke();

            // A√ßƒ± Kolu
            ctx.beginPath();
            ctx.moveTo(center.x, center.y);
            ctx.lineTo(endPt.x, endPt.y);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();

            // A√ßƒ± Hesapla
            const baseAngle = Math.atan2(refPt.y - center.y, refPt.x - center.x);
            const currentAngle = Math.atan2(endPt.y - center.y, endPt.x - center.x);
            
            let diff = currentAngle - baseAngle;
            // En kƒ±sa yol i√ßin normalize et: [-PI, PI] aralƒ±ƒüƒ±na sƒ±kƒ±≈ütƒ±r
            while (diff <= -Math.PI) diff += 2*Math.PI;
            while (diff > Math.PI) diff -= 2*Math.PI;

            // Yay √áiz
            ctx.beginPath();
            // Eƒüer fark negatifse, canvas arc y√∂n√º true (CCW) olmalƒ± ki kƒ±sa yolu √ßizsin
            ctx.arc(center.x, center.y, 30, baseAngle, baseAngle + diff, diff < 0);
            ctx.strokeStyle = color;
            ctx.stroke();

            drawDot(center, color);
            
            // Sayƒ±sal deƒüeri a√ßƒ±nƒ±n g√∂sterildiƒüi yere (a√ßƒ±ortay √ºzerine) yaz
            let degrees = Math.abs(diff * 180 / Math.PI);
            
            // Etiket konumunu hesapla
            let midAngle = baseAngle + (diff / 2);
            let labelDist = 60; // Yaydan biraz dƒ±≈üarƒ±da
            // drawLabel fonksiyonu x+10, y+10 ofsetli √ßizdiƒüi i√ßin konumu hafif√ße ayarlƒ±yoruz (-25)
            let lx = center.x + Math.cos(midAngle) * labelDist - 25;
            let ly = center.y + Math.sin(midAngle) * labelDist - 25;

            drawLabel(`${Math.round(degrees)}¬∞`, lx, ly, color);
        }

        // --- Aktif Ara√ß √áizimleri ---

        function drawReferenceLinePreview() {
            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(currentPoint.x, currentPoint.y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]); 
            ctx.stroke();
            ctx.setLineDash([]);
            
            drawDot(startPoint, currentColor);
            drawLabel("Ba≈ülangƒ±√ß Kolu", currentPoint.x, currentPoint.y, currentColor);
        }

        function drawAngleMeasurementPreview() {
            // 1. Referans Kolu
            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(referencePoint.x, referencePoint.y);
            ctx.strokeStyle = 'rgba(0,0,0,0.5)';
            ctx.lineWidth = 3;
            ctx.stroke();

            // 2. Aktif Kol
            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(currentPoint.x, currentPoint.y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            // 3. ƒ∞letkiyi Referans Koluna Hizala
            const baseAngle = Math.atan2(referencePoint.y - startPoint.y, referencePoint.x - startPoint.x);
            
            ctx.save();
            ctx.translate(startPoint.x, startPoint.y);
            ctx.rotate(baseAngle); 
            
            // --- ƒ∞letki G√∂rseli ---
            const r = 130;
            
            // Daire
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, 2*Math.PI);
            ctx.fillStyle = 'rgba(255, 237, 213, 0.5)';
            ctx.fill();
            ctx.strokeStyle = '#ea580c';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Dereceler
            ctx.font = '10px Montserrat';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#7c2d12';

            for(let i=0; i<360; i+=10) {
                let rad = (i * Math.PI) / 180;
                let outer = r;
                let inner = (i%30===0) ? r-15 : r-5;
                
                ctx.beginPath();
                ctx.moveTo(Math.cos(rad)*outer, Math.sin(rad)*outer);
                ctx.lineTo(Math.cos(rad)*inner, Math.sin(rad)*inner);
                ctx.stroke();

                if(i%30===0) {
                    let tx = Math.cos(rad) * (r-25);
                    let ty = Math.sin(rad) * (r-25);
                    ctx.fillText(i, tx, ty);
                }
            }
            
            // Taranmƒ±≈ü ƒ∞√á A√áI Alanƒ±
            const mouseAngleGlobal = Math.atan2(currentPoint.y - startPoint.y, currentPoint.x - startPoint.x);
            let relativeAngle = mouseAngleGlobal - baseAngle;
            
            // En kƒ±sa yol normalizasyonu
            while (relativeAngle <= -Math.PI) relativeAngle += 2*Math.PI;
            while (relativeAngle > Math.PI) relativeAngle -= 2*Math.PI;

            ctx.beginPath();
            ctx.moveTo(0,0);
            // Negatif a√ßƒ± ise CCW (true) √ßiz, Pozitif ise CW (false) √ßiz
            ctx.arc(0, 0, r, 0, relativeAngle, relativeAngle < 0);
            ctx.lineTo(0,0);
            ctx.fillStyle = 'rgba(234, 88, 12, 0.3)';
            ctx.fill();

            ctx.restore();

            // Etiket Pozisyonu (A√ßƒ±ortay √ºzerinde, iletki dƒ±≈üƒ±nda)
            let degrees = Math.abs(relativeAngle * (180/Math.PI));
            let midRelAngle = relativeAngle / 2;
            let globalMidAngle = baseAngle + midRelAngle;
            let labelR = r + 40; // ƒ∞letki yarƒ±√ßapƒ± (130) + 40px dƒ±≈üarƒ±
            
            // drawLabel +10 offset eklediƒüi i√ßin merkeze oturtmak adƒ±na -25 yapƒ±yoruz
            let lx = startPoint.x + Math.cos(globalMidAngle) * labelR - 25;
            let ly = startPoint.y + Math.sin(globalMidAngle) * labelR - 25;

            drawLabel(`${Math.round(degrees)}¬∞`, lx, ly, currentColor);
            
            drawDot(startPoint, currentColor);
        }

        function drawActiveRuler() {
            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(currentPoint.x, currentPoint.y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            const dx = currentPoint.x - startPoint.x;
            const dy = currentPoint.y - startPoint.y;
            const pixelDist = Math.sqrt(dx*dx + dy*dy);
            const cm = (pixelDist / PIXELS_PER_CM).toFixed(1);

            drawLabel(`${cm} cm`, currentPoint.x, currentPoint.y, currentColor);

            ctx.save();
            ctx.translate(startPoint.x, startPoint.y);
            ctx.rotate(Math.atan2(dy, dx));
            
            ctx.fillStyle = 'rgba(250, 204, 21, 0.4)'; 
            ctx.fillRect(0, 10, pixelDist + 40, 40);
            
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(0,0,0,0.5)';
            ctx.lineWidth = 1;
            ctx.font = '500 10px Montserrat';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';

            const totalCm = Math.ceil(pixelDist / PIXELS_PER_CM);
            for(let i=0; i<= totalCm+1; i++) {
                let x = i * PIXELS_PER_CM;
                if(x > pixelDist + 30) break;
                ctx.moveTo(x, 10);
                ctx.lineTo(x, 25);
                ctx.fillText(i, x, 38);
                for(let j=1; j<10; j++) {
                    let mx = x + (j * PIXELS_PER_CM/10);
                    if(mx > pixelDist + 30) break;
                    ctx.moveTo(mx, 10);
                    ctx.lineTo(mx, j==5? 20 : 15);
                }
            }
            ctx.stroke();
            ctx.restore();
        }

        function drawActiveCompass() {
            const dx = currentPoint.x - startPoint.x;
            const dy = currentPoint.y - startPoint.y;
            const radius = Math.sqrt(dx*dx + dy*dy);
            const cm = (radius / PIXELS_PER_CM).toFixed(1);

            ctx.beginPath();
            ctx.arc(startPoint.x, startPoint.y, radius, 0, Math.PI*2);
            ctx.strokeStyle = currentColor;
            ctx.setLineDash([5,5]);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(currentPoint.x, currentPoint.y);
            ctx.strokeStyle = '#d8b4fe';
            ctx.stroke();

            drawLabel(`r: ${cm} cm`, currentPoint.x, currentPoint.y, currentColor);

            const midX = (startPoint.x + currentPoint.x) / 2;
            const midY = (startPoint.y + currentPoint.y) / 2;
            const topY = midY - 120; 

            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y); 
            ctx.lineTo(midX, topY); 
            ctx.lineTo(currentPoint.x, currentPoint.y); 
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#7e22ce'; 
            ctx.lineWidth = 6;
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(midX, topY, 8, 0, Math.PI*2);
            ctx.fillStyle = '#581c87';
            ctx.fill();
        }

        resizeCanvas();

    </script>
</body>
</html>